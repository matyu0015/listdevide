<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExcelÂ≠¶Áîü„Ç∞„É´„Éº„ÉóÈÖçÂàÜ„Ç∑„Çπ„ÉÜ„É† - ÂÆåÂÖ®Áâà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .step-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 15px;
        }
        
        .step-title {
            font-size: 1.4em;
            color: #333;
        }
        
        .file-input-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-area:hover {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        
        .file-input-area.dragover {
            background: #e3f2fd;
            border-color: #0056b3;
            transform: scale(1.02);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .mapping-item {
            display: flex;
            flex-direction: column;
        }
        
        .mapping-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }
        
        .mapping-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 1em;
            cursor: pointer;
        }
        
        .button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        
        .button-primary {
            background: #007bff;
            color: white;
        }
        
        .button-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        .button-success {
            background: #28a745;
            color: white;
        }
        
        .button-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        
        .button-warning {
            background: #ffc107;
            color: #333;
        }
        
        .button-info {
            background: #17a2b8;
            color: white;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .preview-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            align-items: center;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #c8e6c9;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        
        .results-container {
            display: none;
        }
        
        .group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .group-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        
        .group-header {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #007bff;
        }
        
        .student-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            display: none;
        }
        
        .debug-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-left: 3px solid #007bff;
            background: white;
        }
        
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÁî®„Çπ„Çø„Ç§„É´ */
        .draggable {
            cursor: move;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .drag-over {
            background-color: #e3f2fd !important;
            border: 2px dashed #2196f3;
        }
        
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 250px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }
            
            .step-container {
                padding: 20px;
            }
            
            .mapping-grid {
                grid-template-columns: 1fr;
            }
            
            .group-grid {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                position: static;
                margin-bottom: 20px;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä ExcelÂ≠¶Áîü„Ç∞„É´„Éº„ÉóÈÖçÂàÜ„Ç∑„Çπ„ÉÜ„É†</h1>
        <p>Â≠¶Áîü„Éá„Éº„Çø„ÇíËá™Âãï„Åß14„Ç∞„É´„Éº„Éó„Å´ÂùáÁ≠âÈÖçÂàÜ„Åó„Åæ„Åô</p>
    </div>
    
    <div class="container">
        <!-- „Çπ„ÉÜ„ÉÉ„Éó1: „Éï„Ç°„Ç§„É´ÈÅ∏Êäû -->
        <div class="step-container">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2 class="step-title">Excel„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</h2>
            </div>
            
            <div class="file-input-area" id="dropZone">
                <div class="file-icon">üìÅ</div>
                <p style="font-size: 1.2em; margin-bottom: 10px;">
                    „ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
                </p>
                <p style="color: #6c757d;">
                    ÂØæÂøúÂΩ¢Âºè: .xlsx, .xls
                </p>
                <input type="file" id="excel-file" accept=".xlsx,.xls">
            </div>
            
            <div id="file-info" style="margin-top: 20px; display: none;">
                <p style="color: #28a745;">
                    ‚úÖ „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: <strong id="file-name"></strong>
                </p>
            </div>
        </div>
        
        <!-- „Çπ„ÉÜ„ÉÉ„Éó2: Âàó„Éû„ÉÉ„Éî„É≥„Ç∞ -->
        <div id="mapping-section" class="step-container" style="display: none;">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2 class="step-title">„Éá„Éº„ÇøÈ†ÖÁõÆ„ÅÆË®≠ÂÆö</h2>
            </div>
            
            <div class="mapping-grid">
                <div class="mapping-item">
                    <label class="mapping-label">Ê∞èÂêçÂàó <span style="color: red;">*</span></label>
                    <select id="col-name" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">Â§ßÂ≠¶Âàó <span style="color: red;">*</span></label>
                    <select id="col-university" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">Â≠¶ÈÉ®Âàó</label>
                    <select id="col-department" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">ÊñáÁêÜÂàó <span style="color: red;">*</span></label>
                    <select id="col-major" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">ÊÄßÂà•Âàó <span style="color: red;">*</span></label>
                    <select id="col-gender" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">Â§ßÂ≠¶Áîü/Â§ßÂ≠¶Èô¢Âàó <span style="color: red;">*</span></label>
                    <select id="col-graduate" class="mapping-select"></select>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="button button-primary" onclick="previewData()">
                    „Éá„Éº„Çø„Éó„É¨„Éì„É•„Éº
                </button>
                <button class="button button-info" onclick="autoDetectColumns()">
                    Ëá™ÂãïÊ§úÂá∫
                </button>
            </div>
        </div>
        
        <!-- „Çπ„ÉÜ„ÉÉ„Éó3: „Éó„É¨„Éì„É•„Éº -->
        <div id="preview-section" class="step-container" style="display: none;">
            <div class="step-header">
                <div class="step-number">3</div>
                <h2 class="step-title">„Éá„Éº„ÇøÁ¢∫Ë™ç</h2>
            </div>
            
            <div id="preview-stats" class="stats-grid"></div>
            
            <div id="preview-table-container" style="overflow-x: auto;"></div>
            
            <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <div style="margin-bottom: 15px;">
                    <label for="group-count-select" style="font-weight: 600; margin-right: 10px;">„Ç∞„É´„Éº„ÉóÊï∞:</label>
                    <select id="group-count-select" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; cursor: pointer;">
                        <!-- 1„Äú30„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê -->
                    </select>
                    <span style="margin-left: 10px; color: #6c757d;">Ôºà„Éá„Éï„Ç©„É´„Éà: 14„Ç∞„É´„Éº„ÉóÔºâ</span>
                </div>
                <button class="button button-success" onclick="executeAllocation()">
                    „Ç∞„É´„Éº„ÉóÈÖçÂàÜ„ÇíÂÆüË°å
                </button>
                <button class="button button-warning" onclick="showDebugLog()">
                    „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞Ë°®Á§∫
                </button>
            </div>
        </div>
        
        <!-- „Çπ„ÉÜ„ÉÉ„Éó4: ÁµêÊûú -->
        <div id="results-section" class="step-container results-container">
            <div class="step-header">
                <div class="step-number">4</div>
                <h2 class="step-title">ÈÖçÂàÜÁµêÊûú</h2>
            </div>
            
            <div id="results-summary"></div>
            
            <div style="margin: 20px 0;">
                <button class="button button-success" onclick="downloadExcel()">
                    üì• ExcelÂΩ¢Âºè„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </button>
                <button class="button button-primary" onclick="downloadHTML()">
                    üìÑ HTMLÂΩ¢Âºè„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàÁ∑®ÈõÜÂèØËÉΩÔºâ
                </button>
                <button class="button button-info" onclick="showDetailedResults()">
                    Ë©≥Á¥∞Ë°®Á§∫
                </button>
            </div>
            
            <div id="groups-display"></div>
        </div>
        
        <!-- „Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏ -->
        <div id="status-message" class="status-message"></div>
        
        <!-- „É≠„Éº„ÉÄ„Éº -->
        <div id="loader" class="loader">
            <div class="loader-spinner"></div>
            <p style="margin-top: 20px;">Âá¶ÁêÜ‰∏≠...</p>
        </div>
        
        <!-- „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ -->
        <div id="debug-log" class="debug-log"></div>
    </div>
    
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let workbook = null;
        let excelData = null;
        let headers = [];
        let students = [];
        let groups = {};
        let debugLog = [];
        let originalData = [];
        let columnMapping = {};
        
        const CONFIG = {
            groupCount: 14,  // „Éá„Éï„Ç©„É´„ÉàÂÄ§
            get maxUniversityPerGroup() {
                // „Ç∞„É´„Éº„ÉóÊï∞„Å´Âøú„Åò„Å¶ÂãïÁöÑ„Å´Ë®àÁÆó
                // „Ç∞„É´„Éº„ÉóÊï∞„ÅåÂ∞ë„Å™„ÅÑÂ†¥Âêà„ÅØÂà∂Èôê„ÇíÁ∑©Âíå
                if (this.groupCount <= 5) return 10;
                if (this.groupCount <= 10) return 6;
                if (this.groupCount <= 15) return 4;
                return 3;
            }
        };
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('excel-file');
            
            // „Ç∞„É´„Éº„ÉóÊï∞„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂàùÊúüÂåñ
            initializeGroupCountSelect();
            
            // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            dropZone.addEventListener('click', function() {
                fileInput.click();
            });
            
            // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Ç§„Éô„É≥„Éà
            fileInput.addEventListener('change', function(event) {
                handleFileSelect(event);
            });
            
            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„Éà
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // „Éè„Ç§„É©„Ç§„ÉàËøΩÂä†/ÂâäÈô§
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            // „Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ
            dropZone.addEventListener('drop', handleDrop, false);
        });
        
        // „Ç∞„É´„Éº„ÉóÊï∞„Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂàùÊúüÂåñ
        function initializeGroupCountSelect() {
            const select = document.getElementById('group-count-select');
            if (!select) return;
            
            // 1„Äú30„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + '„Ç∞„É´„Éº„Éó';
                if (i === 14) {
                    option.selected = true;  // „Éá„Éï„Ç©„É´„ÉàÂÄ§
                }
                select.appendChild(option);
            }
            
            // Â§âÊõ¥„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            select.addEventListener('change', function() {
                CONFIG.groupCount = parseInt(this.value);
                const maxUniv = CONFIG.maxUniversityPerGroup;
                showStatus(`„Ç∞„É´„Éº„ÉóÊï∞„Çí${CONFIG.groupCount}„Å´Â§âÊõ¥„Åó„Åæ„Åó„ÅüÔºàÂêå‰∏ÄÂ§ßÂ≠¶‰∏äÈôê: ${maxUniv}Âêç/„Ç∞„É´„Éº„ÉóÔºâ`, 'info');
            });
        }
        
        // „Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÈò≤„Åê
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // „Éè„Ç§„É©„Ç§„Éà
        function highlight(e) {
            document.getElementById('dropZone').classList.add('dragover');
        }
        
        // „Éè„Ç§„É©„Ç§„ÉàËß£Èô§
        function unhighlight(e) {
            document.getElementById('dropZone').classList.remove('dragover');
        }
        
        // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        // „Éï„Ç°„Ç§„É´Âá¶ÁêÜ
        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('Excel„Éï„Ç°„Ç§„É´Ôºà.xlsx „Åæ„Åü„ÅØ .xlsÔºâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-info').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (excelData && excelData.length > 0) {
                        headers = excelData[0];
                        originalData = excelData.slice(1);
                        setupColumnMapping();
                        document.getElementById('mapping-section').style.display = 'block';
                        showStatus('„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇÂàó„ÅÆË®≠ÂÆö„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
                    }
                } catch (error) {
                    showStatus('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Âàó„Éû„ÉÉ„Éî„É≥„Ç∞Ë®≠ÂÆö
        function setupColumnMapping() {
            const selects = ['col-name', 'col-university', 'col-department', 'col-major', 'col-gender', 'col-graduate'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
                
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header || `Âàó${index + 1}`;
                    select.appendChild(option);
                });
            });
        }
        
        // Ëá™ÂãïÊ§úÂá∫
        function autoDetectColumns() {
            const mappings = {
                'col-name': ['Ê∞èÂêç', 'ÂêçÂâç', 'Name', 'ÂßìÂêç'],
                'col-university': ['Â§ßÂ≠¶', 'Â§ßÂ≠¶Âêç', 'University', 'Â≠¶Ê†°'],
                'col-department': ['Â≠¶ÈÉ®', 'Â≠¶Áßë', 'Department', 'Â∞ÇÊîª'],
                'col-major': ['ÊñáÁêÜ', 'ÊñáÁ≥ªÁêÜÁ≥ª', 'Â∞ÇÊîªÂå∫ÂàÜ', 'Major'],
                'col-gender': ['ÊÄßÂà•', 'Gender', 'Áî∑Â•≥'],
                'col-graduate': ['Â§ßÂ≠¶Áîü/Â§ßÂ≠¶Èô¢', 'Â≠¶ÈÉ®/Â§ßÂ≠¶Èô¢', 'Â≠¶Ê†°Âå∫ÂàÜ', 'Graduate']
            };
            
            for (const [selectId, keywords] of Object.entries(mappings)) {
                const select = document.getElementById(selectId);
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i] ? headers[i].toString() : '';
                    if (keywords.some(keyword => header.includes(keyword))) {
                        select.value = i;
                        break;
                    }
                }
            }
            
            showStatus('Ëá™ÂãïÊ§úÂá∫„ÇíÂÆüË°å„Åó„Åæ„Åó„Åü„ÄÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
        }
        
        // „Éá„Éº„Çø„Éó„É¨„Éì„É•„Éº
        function previewData() {
            const nameCol = document.getElementById('col-name').value;
            const univCol = document.getElementById('col-university').value;
            const majorCol = document.getElementById('col-major').value;
            const genderCol = document.getElementById('col-gender').value;
            const gradCol = document.getElementById('col-graduate').value;
            
            if (!nameCol || !univCol || !majorCol || !genderCol || !gradCol) {
                showStatus('ÂøÖÈ†àÈ†ÖÁõÆÔºà*Ôºâ„Çí„Åô„Åπ„Å¶ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            // Âàó„Éû„ÉÉ„Éî„É≥„Ç∞„Çí‰øùÂ≠ò
            columnMapping = {
                name: parseInt(nameCol),
                university: parseInt(univCol),
                department: document.getElementById('col-department').value ? parseInt(document.getElementById('col-department').value) : null,
                major: parseInt(majorCol),
                gender: parseInt(genderCol),
                graduate: parseInt(gradCol)
            };
            
            // „Éá„Éº„ÇøËß£Êûê
            students = [];
            originalData.forEach((row, index) => {
                if (row[columnMapping.name]) {
                    students.push({
                        id: index,
                        name: row[columnMapping.name].toString().trim(),
                        university: row[columnMapping.university] || 'Êú™Ë®≠ÂÆö',
                        department: columnMapping.department !== null ? (row[columnMapping.department] || '') : '',
                        major: parseMajor(row[columnMapping.major]),
                        gender: parseGender(row[columnMapping.gender]),
                        isGraduate: isGraduate(row[columnMapping.graduate]),
                        originalData: row,
                        assigned: false,
                        groupId: null
                    });
                }
            });
            
            // Áµ±Ë®àË°®Á§∫
            displayPreviewStats();
            
            // „Éó„É¨„Éì„É•„Éº„ÉÜ„Éº„Éñ„É´Ë°®Á§∫
            displayPreviewTable();
            
            document.getElementById('preview-section').style.display = 'block';
            showStatus(`${students.length}Âêç„ÅÆÂ≠¶Áîü„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Åü`, 'success');
        }
        
        // ÊñáÁêÜÂà§ÂÆö
        function parseMajor(value) {
            if (!value) return 'Êñá';
            const str = value.toString();
            if (str.includes('ÁêÜ') || str === 'ÁêÜÁ≥ª') return 'ÁêÜ';
            if (str.includes('Êñá') || str === 'ÊñáÁ≥ª') return 'Êñá';
            return 'Êñá';
        }
        
        // ÊÄßÂà•Âà§ÂÆö
        function parseGender(value) {
            if (!value) return '‰∏çÊòé';
            const str = value.toString();
            if (str === 'Áî∑' || str === 'Áî∑ÊÄß' || str === 'M' || str === 'm') return 'Áî∑';
            if (str === 'Â•≥' || str === 'Â•≥ÊÄß' || str === 'F' || str === 'f') return 'Â•≥';
            return '‰∏çÊòé';
        }
        
        // Â§ßÂ≠¶Èô¢Âà§ÂÆö
        function isGraduate(value) {
            if (!value) return false;
            const str = value.toString();
            return str.includes('Èô¢') || str === 'Â§ßÂ≠¶Èô¢' || str === 'Graduate';
        }
        
        // Áµ±Ë®àË°®Á§∫
        function displayPreviewStats() {
            const stats = {
                total: students.length,
                female: students.filter(s => s.gender === 'Â•≥').length,
                male: students.filter(s => s.gender === 'Áî∑').length,
                science: students.filter(s => s.major === 'ÁêÜ').length,
                humanities: students.filter(s => s.major === 'Êñá').length,
                graduate: students.filter(s => s.isGraduate).length,
                undergraduate: students.filter(s => !s.isGraduate).length
            };
            
            document.getElementById('preview-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Á∑èÂ≠¶ÁîüÊï∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.female}</div>
                    <div class="stat-label">Â•≥ÊÄß</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.male}</div>
                    <div class="stat-label">Áî∑ÊÄß</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.science}</div>
                    <div class="stat-label">ÁêÜÁ≥ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.humanities}</div>
                    <div class="stat-label">ÊñáÁ≥ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.graduate}</div>
                    <div class="stat-label">Â§ßÂ≠¶Èô¢Áîü</div>
                </div>
            `;
        }
        
        // „Éó„É¨„Éì„É•„Éº„ÉÜ„Éº„Éñ„É´Ë°®Á§∫
        function displayPreviewTable() {
            let html = '<table class="preview-table">';
            html += '<thead><tr><th>Ê∞èÂêç</th><th>Â§ßÂ≠¶</th><th>Â≠¶ÈÉ®</th><th>ÊñáÁêÜ</th><th>ÊÄßÂà•</th><th>Â≠¶Ê†°Âå∫ÂàÜ</th></tr></thead>';
            html += '<tbody>';
            
            const displayCount = Math.min(10, students.length);
            for (let i = 0; i < displayCount; i++) {
                const s = students[i];
                html += `<tr>
                    <td>${s.name}</td>
                    <td>${s.university}</td>
                    <td>${s.department || '-'}</td>
                    <td>${s.major}</td>
                    <td>${s.gender}</td>
                    <td>${s.isGraduate ? 'Â§ßÂ≠¶Èô¢' : 'Â§ßÂ≠¶Áîü'}</td>
                </tr>`;
            }
            
            if (students.length > displayCount) {
                html += `<tr><td colspan="6" style="text-align: center; color: #6c757d;">... ‰ªñ ${students.length - displayCount} Âêç</td></tr>`;
            }
            
            html += '</tbody></table>';
            document.getElementById('preview-table-container').innerHTML = html;
        }
        
        // ÈÖçÂàÜÂÆüË°å
        function executeAllocation() {
            // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Ç∞„É´„Éº„ÉóÊï∞„ÇíÂèñÂæó
            const selectedGroupCount = document.getElementById('group-count-select').value;
            CONFIG.groupCount = parseInt(selectedGroupCount);
            
            showLoader(true);
            debugLog = [];
            
            setTimeout(() => {
                try {
                    allocateStudents();
                    displayResults();
                    showStatus(`${CONFIG.groupCount}„Ç∞„É´„Éº„Éó„Å∏„ÅÆÈÖçÂàÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ`, 'success');
                    document.getElementById('results-section').style.display = 'block';
                } catch (error) {
                    showStatus('ÈÖçÂàÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'error');
                    console.error(error);
                } finally {
                    showLoader(false);
                }
            }, 100);
        }
        
        // Â≠¶ÁîüÈÖçÂàÜ„Ç¢„É´„Ç¥„É™„Ç∫„É†ÔºàkintoneÁâà„Å®Âêå„ÅòÔºâ
        function allocateStudents() {
            // „Ç∞„É´„Éº„ÉóÂàùÊúüÂåñ
            groups = {};
            for (let i = 0; i < CONFIG.groupCount; i++) {
                groups[i] = {
                    id: i,
                    students: []
                };
            }
            
            // Â≠¶Áîü„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà
            students.forEach(s => {
                s.assigned = false;
                s.groupId = null;
            });
            
            const tracker = initializeTracker();
            const attributeTargets = calculateAttributeTargets();
            const universityInfo = analyzeUniversities();
            
            // „Çπ„ÉÜ„ÉÉ„Éó1: „Ç∞„É´„Éº„Éó„Åî„Å®„ÅÆÁõÆÊ®ô‰∫∫Êï∞
            const groupTargetSizes = calculateGroupSizes(students.length, CONFIG.groupCount);
            
            // „Çπ„ÉÜ„ÉÉ„Éó1.5: Êó©Á®≤Áî∞Â§ßÂ≠¶„Å®ÊÖ∂ÊáâÂ§ßÂ≠¶„ÅÆÂ≠¶Áîü„ÇíÂÑ™ÂÖàÁöÑ„Å´ÂùáÁ≠âÈÖçÂàÜ
            addDebugLog('STEP1.5', 'Êó©Á®≤Áî∞Â§ßÂ≠¶„ÉªÊÖ∂ÊáâÂ§ßÂ≠¶„ÅÆÂÑ™ÂÖàÈÖçÂàÜ„ÇíÈñãÂßã');
            allocatePriorityUniversities(tracker, groupTargetSizes);
            checkAndFixStep('STEP1.5', 'Êó©ÊÖ∂ÂÑ™ÂÖàÈÖçÂàÜÂæå', attributeTargets, tracker, groupTargetSizes);
            
            // „Çπ„ÉÜ„ÉÉ„Éó2: Â±ûÊÄß„Åî„Å®„Å´ÂùáÁ≠âÈÖçÂàÜ
            addDebugLog('STEP2', 'Â±ûÊÄßÂà•ÈÖçÂàÜ„ÇíÈñãÂßã');
            allocateByAttributesEvenly(attributeTargets, tracker, groupTargetSizes);
            checkAndFixStep('STEP2', 'Â±ûÊÄßÂà•ÈÖçÂàÜÂæå', attributeTargets, tracker, groupTargetSizes);
            
            // „Çπ„ÉÜ„ÉÉ„Éó3: Â§ßÂ≠¶„ÅÆÈáçË§áÂà∂Á¥Ñ„ÇíÂá¶ÁêÜ
            addDebugLog('STEP3', 'Â§ßÂ≠¶Âà∂Á¥ÑÂá¶ÁêÜ„ÇíÈñãÂßã');
            handleUniversityConstraintsImproved(universityInfo, tracker, groupTargetSizes);
            checkAndFixStep('STEP3', 'Â§ßÂ≠¶Âà∂Á¥ÑÂá¶ÁêÜÂæå', attributeTargets, tracker, groupTargetSizes);
            
            // „Çπ„ÉÜ„ÉÉ„Éó4: ÊÆã„Çä„ÅÆÂ≠¶Áîü„ÇíÂùáÁ≠âÈÖçÁΩÆ
            addDebugLog('STEP4', 'ÊÆã„ÇäÂ≠¶ÁîüÈÖçÁΩÆ„ÇíÈñãÂßã');
            allocateRemainingEvenly(tracker, groupTargetSizes);
            checkAndFixStep('STEP4', 'ÊÆã„ÇäÂ≠¶ÁîüÈÖçÁΩÆÂæå', attributeTargets, tracker, groupTargetSizes);
            
            // „Çπ„ÉÜ„ÉÉ„Éó5: ÊúÄÁµÇË™øÊï¥
            addDebugLog('STEP5', 'ÊúÄÁµÇË™øÊï¥„ÇíÈñãÂßã');
            finalAdjustment(tracker, attributeTargets, groupTargetSizes);
            
            // „Çπ„ÉÜ„ÉÉ„Éó6: ÂæπÂ∫ïÁöÑ„Å™ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ë™øÊï¥
            addDebugLog('STEP6', 'ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ëá™ÂãïË™øÊï¥„ÇíÈñãÂßã');
            performComprehensiveFinalCheck(attributeTargets, tracker, groupTargetSizes);
            
            // ÊúÄÁµÇÁ¢∫Ë™ç
            performFinalCheck(attributeTargets, tracker, groupTargetSizes);
        }
        
        // „Ç´„ÉÜ„Ç¥„É™„ÉºÂàÜÈ°û
        function categorizeStudents() {
            return {
                'Â•≥ÊÄßÁêÜÁ≥ªÈô¢Áîü': students.filter(s => !s.assigned && s.gender === 'Â•≥' && s.major === 'ÁêÜ' && s.isGraduate),
                'Â•≥ÊÄßÁêÜÁ≥ªÂ≠¶ÈÉ®': students.filter(s => !s.assigned && s.gender === 'Â•≥' && s.major === 'ÁêÜ' && !s.isGraduate),
                'Â•≥ÊÄßÊñáÁ≥ªÈô¢Áîü': students.filter(s => !s.assigned && s.gender === 'Â•≥' && s.major === 'Êñá' && s.isGraduate),
                'Â•≥ÊÄßÊñáÁ≥ªÂ≠¶ÈÉ®': students.filter(s => !s.assigned && s.gender === 'Â•≥' && s.major === 'Êñá' && !s.isGraduate),
                'Áî∑ÊÄßÁêÜÁ≥ªÈô¢Áîü': students.filter(s => !s.assigned && s.gender === 'Áî∑' && s.major === 'ÁêÜ' && s.isGraduate),
                'Áî∑ÊÄßÁêÜÁ≥ªÂ≠¶ÈÉ®': students.filter(s => !s.assigned && s.gender === 'Áî∑' && s.major === 'ÁêÜ' && !s.isGraduate),
                'Áî∑ÊÄßÊñáÁ≥ªÈô¢Áîü': students.filter(s => !s.assigned && s.gender === 'Áî∑' && s.major === 'Êñá' && s.isGraduate),
                'Áî∑ÊÄßÊñáÁ≥ªÂ≠¶ÈÉ®': students.filter(s => !s.assigned && s.gender === 'Áî∑' && s.major === 'Êñá' && !s.isGraduate)
            };
        }
        
        // Êó©Á®≤Áî∞Â§ßÂ≠¶„Å®ÊÖ∂ÊáâÂ§ßÂ≠¶„ÅÆÂÑ™ÂÖàÈÖçÂàÜ
        function allocatePriorityUniversities(tracker, groupTargetSizes) {
            // Êó©Á®≤Áî∞„Å®ÊÖ∂Êáâ„ÅÆÂ≠¶Áîü„ÇíÊäΩÂá∫
            const wasedaStudents = students.filter(s => !s.assigned && 
                (s.university.includes('Êó©Á®≤Áî∞') || s.university.includes('Waseda')));
            const keioStudents = students.filter(s => !s.assigned && 
                (s.university.includes('ÊÖ∂Êáâ') || s.university.includes('ÊÖ∂Âøú') || s.university.includes('Keio')));
            
            // Êó©Á®≤Áî∞Â§ßÂ≠¶„ÅÆÂ≠¶Áîü„ÇíÂùáÁ≠âÈÖçÂàÜ
            if (wasedaStudents.length > 0) {
                addDebugLog('PRIORITY', `Êó©Á®≤Áî∞Â§ßÂ≠¶: ${wasedaStudents.length}Âêç„ÇíÂùáÁ≠âÈÖçÂàÜ`);
                distributeStudentsEvenly(wasedaStudents, tracker, groupTargetSizes, 'Êó©Á®≤Áî∞Â§ßÂ≠¶');
            }
            
            // ÊÖ∂ÊáâÂ§ßÂ≠¶„ÅÆÂ≠¶Áîü„ÇíÂùáÁ≠âÈÖçÂàÜ
            if (keioStudents.length > 0) {
                addDebugLog('PRIORITY', `ÊÖ∂ÊáâÂ§ßÂ≠¶: ${keioStudents.length}Âêç„ÇíÂùáÁ≠âÈÖçÂàÜ`);
                distributeStudentsEvenly(keioStudents, tracker, groupTargetSizes, 'ÊÖ∂ÊáâÂ§ßÂ≠¶');
            }
        }
        
        // ÁâπÂÆö„ÅÆÂ≠¶Áîü„Ç∞„É´„Éº„Éó„ÇíÂùáÁ≠â„Å´ÈÖçÂàÜ
        function distributeStudentsEvenly(studentGroup, tracker, groupTargetSizes, universityName) {
            // ÂêÑ„Ç∞„É´„Éº„Éó„Å´ÈÖçÂàÜ„Åô„Çã‰∫∫Êï∞„ÇíË®àÁÆó
            const baseCount = Math.floor(studentGroup.length / CONFIG.groupCount);
            const remainder = studentGroup.length % CONFIG.groupCount;
            
            let studentIndex = 0;
            
            // ÂêÑ„Ç∞„É´„Éº„Éó„Å´Âü∫Êú¨‰∫∫Êï∞„ÇíÈÖçÂàÜ
            for (let g = 0; g < CONFIG.groupCount; g++) {
                const targetCount = baseCount + (g < remainder ? 1 : 0);
                let placedCount = 0;
                
                while (placedCount < targetCount && studentIndex < studentGroup.length) {
                    const student = studentGroup[studentIndex];
                    
                    if (groups[g].students.length < groupTargetSizes[g]) {
                        // Âêå‰∏ÄÂ≠¶ÈÉ®„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÅØ„Åô„Çã„Åå„ÄÅÂ§ßÂ≠¶ÈáçË§áÂà∂Á¥Ñ„ÅØÁ∑©Âíå
                        const sameDept = student.department && 
                            groups[g].students.some(s => s.university === student.university && 
                                                       s.department === student.department);
                        const sameName = groups[g].students.some(s => s.name === student.name);
                        
                        if (!sameDept && !sameName) {
                            groups[g].students.push(student);
                            student.assigned = true;
                            student.groupId = g;
                            updateTracker(student, g, tracker);
                            placedCount++;
                            addDebugLog('PLACED', `${student.name} (${universityName}) „Çí„Ç∞„É´„Éº„Éó${g+1}„Å´ÈÖçÁΩÆ`);
                        }
                    }
                    
                    studentIndex++;
                }
            }
            
            // ÈÖçÁΩÆ„Åß„Åç„Å™„Åã„Å£„ÅüÂ≠¶Áîü„Åå„ÅÑ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            const unplacedStudents = studentGroup.filter(s => !s.assigned);
            if (unplacedStudents.length > 0) {
                addDebugLog('WARNING', `${universityName}: ${unplacedStudents.length}Âêç„ÅåÊú™ÈÖçÁΩÆ`);
                // Âæå„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅßÈÖçÁΩÆ„Åï„Çå„Çã
            }
        }
        
        // Â±ûÊÄßÂà•ÂùáÁ≠âÈÖçÂàÜ
        function allocateByAttributesEvenly(attributeTargets, tracker, groupTargetSizes) {
            const categories = categorizeStudents();
            
            for (const [categoryName, categoryStudents] of Object.entries(categories)) {
                if (categoryStudents.length === 0) continue;
                
                let groupIndex = 0;
                for (const student of categoryStudents) {
                    let placed = false;
                    let attempts = 0;
                    
                    while (!placed && attempts < CONFIG.groupCount) {
                        const currentGroup = (groupIndex + attempts) % CONFIG.groupCount;
                        
                        if (groups[currentGroup].students.length < groupTargetSizes[currentGroup]) {
                            if (canPlaceStudent(student, groups[currentGroup].students)) {
                                groups[currentGroup].students.push(student);
                                student.assigned = true;
                                student.groupId = currentGroup;
                                updateTracker(student, currentGroup, tracker);
                                placed = true;
                            }
                        }
                        
                        attempts++;
                    }
                    
                    groupIndex = (groupIndex + 1) % CONFIG.groupCount;
                }
            }
        }
        
        // ÈÖçÁΩÆÂèØËÉΩ„ÉÅ„Çß„ÉÉ„ÇØ
        function canPlaceStudent(student, groupStudents) {
            // Âêå‰∏ÄÂ§ßÂ≠¶„ÉÅ„Çß„ÉÉ„ÇØ
            const sameUniv = groupStudents.filter(s => s.university === student.university);
            if (sameUniv.length >= CONFIG.maxUniversityPerGroup) {
                return false;
            }
            
            // Âêå‰∏ÄÂ§ßÂ≠¶„ÉªÂêå‰∏ÄÂ≠¶ÈÉ®„ÉÅ„Çß„ÉÉ„ÇØ
            if (student.department && sameUniv.length > 0) {
                const sameDept = sameUniv.some(s => s.department === student.department);
                if (sameDept) {
                    return false;
                }
            }
            
            // ÂêåÂßìÂêåÂêç„ÉÅ„Çß„ÉÉ„ÇØ
            const sameName = groupStudents.some(s => s.name === student.name);
            if (sameName) {
                return false;
            }
            
            return true;
        }
        
        // Â§ßÂ≠¶Âà∂Á¥ÑÂá¶ÁêÜÔºàÊîπÂñÑÁâàÔºâ
        function handleUniversityConstraintsImproved(universityInfo, tracker, groupTargetSizes) {
            for (const [university, univStudents] of Object.entries(universityInfo.studentsByUniversity)) {
                const assignedByGroup = {};
                const unassigned = [];
                
                for (let g = 0; g < CONFIG.groupCount; g++) {
                    assignedByGroup[g] = groups[g].students.filter(s => s.university === university).length;
                }
                
                for (const student of univStudents) {
                    if (!student.assigned) {
                        unassigned.push(student);
                    }
                }
                
                if (unassigned.length === 0) continue;
                
                for (const student of unassigned) {
                    let bestGroup = -1;
                    let minCount = Infinity;
                    let validGroups = [];
                    
                    for (let g = 0; g < CONFIG.groupCount; g++) {
                        if (groups[g].students.length >= groupTargetSizes[g]) continue;
                        if (assignedByGroup[g] >= CONFIG.maxUniversityPerGroup) continue;
                        
                        if (canPlaceStudent(student, groups[g].students)) {
                            validGroups.push({
                                index: g,
                                count: assignedByGroup[g]
                            });
                        }
                    }
                    
                    if (validGroups.length > 0) {
                        validGroups.sort((a, b) => a.count - b.count);
                        bestGroup = validGroups[0].index;
                    }
                    
                    if (bestGroup !== -1) {
                        groups[bestGroup].students.push(student);
                        student.assigned = true;
                        student.groupId = bestGroup;
                        assignedByGroup[bestGroup]++;
                        updateTracker(student, bestGroup, tracker);
                    }
                }
            }
        }
        
        // ÊÆã„ÇäÂ≠¶ÁîüÈÖçÁΩÆ
        function allocateRemainingEvenly(tracker, groupTargetSizes) {
            const unassigned = students.filter(s => !s.assigned);
            
            if (unassigned.length === 0) return;
            
            const groupSizes = [];
            for (let i = 0; i < CONFIG.groupCount; i++) {
                groupSizes.push({
                    index: i,
                    current: groups[i].students.length,
                    target: groupTargetSizes[i],
                    available: groupTargetSizes[i] - groups[i].students.length
                });
            }
            
            groupSizes.sort((a, b) => b.available - a.available);
            
            for (const student of unassigned) {
                let placed = false;
                
                for (const group of groupSizes) {
                    if (group.available <= 0) continue;
                    
                    if (canPlaceStudent(student, groups[group.index].students)) {
                        groups[group.index].students.push(student);
                        student.assigned = true;
                        student.groupId = group.index;
                        group.current++;
                        group.available--;
                        updateTracker(student, group.index, tracker);
                        placed = true;
                        break;
                    }
                }
                
                if (!placed) {
                    for (const group of groupSizes) {
                        if (group.available <= 0) continue;
                        
                        groups[group.index].students.push(student);
                        student.assigned = true;
                        student.groupId = group.index;
                        group.current++;
                        group.available--;
                        updateTracker(student, group.index, tracker);
                        addDebugLog('WARNING', `${student.name}„ÇíÂà∂Á¥Ñ„ÇíÁ∑©„ÇÅ„Å¶ÈÖçÁΩÆ`);
                        break;
                    }
                }
            }
        }
        
        // ÊúÄÁµÇË™øÊï¥
        function finalAdjustment(tracker, attributeTargets, groupTargetSizes) {
            // ÂêåÂßìÂêåÂêç„ÉÅ„Çß„ÉÉ„ÇØ
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const nameCount = {};
                const duplicates = [];
                
                groups[i].students.forEach(student => {
                    if (nameCount[student.name]) {
                        duplicates.push(student);
                    } else {
                        nameCount[student.name] = true;
                    }
                });
                
                for (const duplicate of duplicates) {
                    for (let j = 0; j < CONFIG.groupCount; j++) {
                        if (i === j) continue;
                        
                        const hasSameName = groups[j].students.some(s => s.name === duplicate.name);
                        if (!hasSameName && groups[j].students.length < groupTargetSizes[j]) {
                            groups[i].students = groups[i].students.filter(s => s !== duplicate);
                            groups[j].students.push(duplicate);
                            duplicate.groupId = j;
                            
                            addDebugLog('FINAL', `ÂêåÂßìÂêåÂêç ${duplicate.name} „Çí„Ç∞„É´„Éº„Éó${i+1}„Åã„Çâ„Ç∞„É´„Éº„Éó${j+1}„Å∏ÁßªÂãï`);
                            break;
                        }
                    }
                }
            }
        }
        
        // „Çπ„ÉÜ„ÉÉ„Éó„ÉÅ„Çß„ÉÉ„ÇØ„Å®‰øÆÊ≠£
        function checkAndFixStep(step, description, attributeTargets, tracker, groupTargetSizes) {
            addDebugLog(step, `${description}„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã`);
            
            const imbalances = checkAllImbalances(attributeTargets, tracker, groupTargetSizes);
            
            if (imbalances.hasAnyImbalance) {
                addDebugLog(step, `${description}: ÂÅè„Çä„ÇíÊ§úÂá∫`, imbalances);
                fixImbalances(imbalances, attributeTargets, tracker, groupTargetSizes);
                addDebugLog(step, `${description}: ÂÅè„Çä‰øÆÊ≠£ÂÆå‰∫Ü`);
            } else {
                addDebugLog(step, `${description}: ÂÅè„Çä„Å™„Åó ‚úì`);
            }
        }
        
        // ÂÅè„Çä„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAllImbalances(attributeTargets, tracker, groupTargetSizes) {
            const result = {
                hasAnyImbalance: false,
                groupSizes: checkGroupSizeImbalance(groupTargetSizes),
                attributes: checkAttributeImbalances(attributeTargets, tracker),
                universities: checkUniversityImbalance()
            };
            
            result.hasAnyImbalance = result.groupSizes.hasImbalance || 
                                    result.attributes.hasImbalance || 
                                    result.universities.hasImbalance;
            
            return result;
        }
        
        // „Ç∞„É´„Éº„Éó„Çµ„Ç§„Ç∫ÂÅè„Çä„ÉÅ„Çß„ÉÉ„ÇØ
        function checkGroupSizeImbalance(groupTargetSizes) {
            const result = {
                hasImbalance: false,
                details: []
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const current = groups[i].students.length;
                const target = groupTargetSizes[i];
                const diff = current - target;
                
                if (Math.abs(diff) > 1) {
                    result.hasImbalance = true;
                    result.details.push({
                        groupId: i,
                        current: current,
                        target: target,
                        diff: diff
                    });
                }
            }
            
            return result;
        }
        
        // Â±ûÊÄßÂÅè„Çä„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAttributeImbalances(attributeTargets, tracker) {
            const result = {
                hasImbalance: false,
                female: [],
                science: [],
                graduate: []
            };
            
            const attributes = ['female', 'science', 'graduate'];
            
            for (const attr of attributes) {
                const distribution = attributeTargets[attr].distribution;
                
                for (let i = 0; i < CONFIG.groupCount; i++) {
                    const current = tracker.attributes[attr][i];
                    const target = distribution[i];
                    const diff = current - target;
                    
                    if (Math.abs(diff) > 1) {
                        result.hasImbalance = true;
                        result[attr].push({
                            groupId: i,
                            current: current,
                            target: target,
                            diff: diff
                        });
                    }
                }
            }
            
            return result;
        }
        
        // Â§ßÂ≠¶ÂÅè„Çä„ÉÅ„Çß„ÉÉ„ÇØ
        function checkUniversityImbalance() {
            const result = {
                hasImbalance: false,
                details: []
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const universities = {};
                groups[i].students.forEach(s => {
                    if (s.university) {
                        universities[s.university] = (universities[s.university] || 0) + 1;
                    }
                });
                
                for (const [univ, count] of Object.entries(universities)) {
                    if (count > CONFIG.maxUniversityPerGroup) {
                        result.hasImbalance = true;
                        result.details.push({
                            groupId: i,
                            university: univ,
                            count: count,
                            excess: count - CONFIG.maxUniversityPerGroup
                        });
                    }
                }
            }
            
            return result;
        }
        
        // ÂÅè„Çä‰øÆÊ≠£ÔºàÁ∞°ÊòìÁâàÔºâ
        function fixImbalances(imbalances, attributeTargets, tracker, groupTargetSizes) {
            // „Åì„Åì„Å´Ë©≥Á¥∞„Å™‰øÆÊ≠£„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÆüË£Ö
            // ‰ªäÂõû„ÅØÁ∞°ÊòìÁâà„Å®„Åó„Å¶Ë≠¶Âëä„ÅÆ„Åø
            if (imbalances.hasAnyImbalance) {
                addDebugLog('FIX', 'ÂÅè„Çä„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü„Åå„ÄÅËá™Âãï‰øÆÊ≠£„ÅØÈÉ®ÂàÜÁöÑ„Åß„Åô');
            }
        }
        
        // ÂæπÂ∫ïÁöÑ„Å™ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ë™øÊï¥
        function performComprehensiveFinalCheck(attributeTargets, tracker, groupTargetSizes) {
            addDebugLog('CHECK', 'ÂæπÂ∫ïÁöÑ„Å™ÊúÄÁµÇ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã');
            
            let adjustmentsMade = true;
            let iterations = 0;
            const maxIterations = 10;
            
            while (adjustmentsMade && iterations < maxIterations) {
                adjustmentsMade = false;
                iterations++;
                addDebugLog('CHECK', `Ë™øÊï¥„É©„Ç¶„É≥„Éâ ${iterations} ÈñãÂßã`);
                
                // 1. ÂêåÂßìÂêåÂêç„ÉÅ„Çß„ÉÉ„ÇØ„Å®‰øÆÊ≠£
                adjustmentsMade |= fixDuplicateNames();
                
                // 2. „Ç∞„É´„Éº„Éó‰∫∫Êï∞„ÅÆÂùáÁ≠âÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Å®‰øÆÊ≠£
                adjustmentsMade |= balanceGroupSizes(groupTargetSizes);
                
                // 3. Â±ûÊÄß„ÅÆÂùáÁ≠âÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Å®‰øÆÊ≠£ÔºàÂ•≥ÊÄß„ÄÅÁêÜÁ≥ª„ÄÅÈô¢ÁîüÔºâ
                adjustmentsMade |= balanceAttributes(['female', 'science', 'graduate']);
                
                // 4. Êó©Á®≤Áî∞„ÉªÊÖ∂Êáâ„ÅÆÂùáÁ≠âÊÄß„ÉÅ„Çß„ÉÉ„ÇØ„Å®‰øÆÊ≠£
                adjustmentsMade |= balanceWasedaKeio();
                
                if (adjustmentsMade) {
                    addDebugLog('CHECK', `Ë™øÊï¥„É©„Ç¶„É≥„Éâ ${iterations} „Åß‰øÆÊ≠£„ÇíÂÆüÊñΩ`);
                }
            }
            
            if (iterations >= maxIterations) {
                addDebugLog('WARNING', 'ÊúÄÂ§ßË™øÊï¥ÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü');
            } else {
                addDebugLog('CHECK', `${iterations}Âõû„ÅÆË™øÊï¥„ÅßÂÆåÂÖ®„Å´ÂùáÁ≠âÂåñ„Åï„Çå„Åæ„Åó„Åü`);
            }
        }
        
        // ÂêåÂßìÂêåÂêç„ÅÆ‰øÆÊ≠£
        function fixDuplicateNames() {
            let fixed = false;
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const nameCount = {};
                const duplicates = [];
                
                groups[i].students.forEach(student => {
                    if (nameCount[student.name]) {
                        duplicates.push(student);
                    } else {
                        nameCount[student.name] = 1;
                    }
                });
                
                for (const duplicate of duplicates) {
                    // ‰ªñ„ÅÆ„Ç∞„É´„Éº„Éó„ÇíÊé¢„Åó„Å¶ÁßªÂãï
                    for (let j = 0; j < CONFIG.groupCount; j++) {
                        if (i === j) continue;
                        
                        const hasSameName = groups[j].students.some(s => s.name === duplicate.name);
                        if (!hasSameName) {
                            // ‰∫§ÊèõÂèØËÉΩ„Å™Â≠¶Áîü„ÇíÊé¢„Åô
                            for (const candidate of groups[j].students) {
                                if (!groups[i].students.some(s => s.name === candidate.name)) {
                                    // ‰∫§ÊèõÂÆüË°å
                                    groups[i].students = groups[i].students.filter(s => s !== duplicate);
                                    groups[j].students = groups[j].students.filter(s => s !== candidate);
                                    groups[i].students.push(candidate);
                                    groups[j].students.push(duplicate);
                                    duplicate.groupId = j;
                                    candidate.groupId = i;
                                    
                                    addDebugLog('FIX', `ÂêåÂßìÂêåÂêç‰øÆÊ≠£: ${duplicate.name}„Çí„Ç∞„É´„Éº„Éó${i+1}„Åã„Çâ${j+1}„Å∏`);
                                    fixed = true;
                                    break;
                                }
                            }
                            if (fixed) break;
                        }
                    }
                    if (fixed) break;
                }
            }
            
            return fixed;
        }
        
        // „Ç∞„É´„Éº„Éó‰∫∫Êï∞„ÅÆ„Éê„É©„É≥„ÇπË™øÊï¥
        function balanceGroupSizes(groupTargetSizes) {
            let adjusted = false;
            const sizes = [];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                sizes.push({
                    index: i,
                    current: groups[i].students.length,
                    target: groupTargetSizes[i],
                    diff: groups[i].students.length - groupTargetSizes[i]
                });
            }
            
            // ÊúÄ„ÇÇ‰∫∫Êï∞„ÅåÂ§ö„ÅÑ„Ç∞„É´„Éº„Éó„Å®Â∞ë„Å™„ÅÑ„Ç∞„É´„Éº„Éó„ÇíÁâπÂÆö
            sizes.sort((a, b) => b.diff - a.diff);
            
            // 2Âêç‰ª•‰∏ä„ÅÆÂ∑Æ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË™øÊï¥
            if (sizes[0].diff > 0 && sizes[sizes.length - 1].diff < 0 && 
                (sizes[0].current - sizes[sizes.length - 1].current) > 1) {
                
                const fromGroup = sizes[0].index;
                const toGroup = sizes[sizes.length - 1].index;
                
                // ÁßªÂãïÂèØËÉΩ„Å™Â≠¶Áîü„ÇíÊé¢„Åô
                for (const student of groups[fromGroup].students) {
                    if (canPlaceStudent(student, groups[toGroup].students)) {
                        // ÁßªÂãïÂÆüË°å
                        groups[fromGroup].students = groups[fromGroup].students.filter(s => s !== student);
                        groups[toGroup].students.push(student);
                        student.groupId = toGroup;
                        
                        addDebugLog('BALANCE', `‰∫∫Êï∞Ë™øÊï¥: ${student.name}„Çí„Ç∞„É´„Éº„Éó${fromGroup+1}Ôºà${sizes[0].current}ÂêçÔºâ„Åã„Çâ${toGroup+1}Ôºà${sizes[sizes.length-1].current}ÂêçÔºâ„Å∏`);
                        adjusted = true;
                        break;
                    }
                }
            }
            
            return adjusted;
        }
        
        // Â±ûÊÄß„ÅÆ„Éê„É©„É≥„ÇπË™øÊï¥
        function balanceAttributes(attributes) {
            let adjusted = false;
            
            for (const attr of attributes) {
                const distribution = calculateCurrentAttributeDistribution(attr);
                const targetDist = calculateTargetDistribution(distribution.total);
                
                // ÊúÄ„ÇÇÂÅè„Å£„Å¶„ÅÑ„Çã„Ç∞„É´„Éº„Éó„ÇíÁâπÂÆö
                let maxDiff = 0;
                let fromGroup = -1;
                let toGroup = -1;
                
                for (let i = 0; i < CONFIG.groupCount; i++) {
                    const current = distribution.byGroup[i];
                    const target = targetDist[i];
                    const diff = current - target;
                    
                    if (Math.abs(diff) > 1) {
                        for (let j = 0; j < CONFIG.groupCount; j++) {
                            if (i === j) continue;
                            const otherDiff = distribution.byGroup[j] - targetDist[j];
                            if (diff > 0 && otherDiff < 0 && Math.abs(diff - otherDiff) > maxDiff) {
                                maxDiff = Math.abs(diff - otherDiff);
                                fromGroup = i;
                                toGroup = j;
                            }
                        }
                    }
                }
                
                // Ë™øÊï¥„ÅåÂøÖË¶Å„Å™Â†¥Âêà
                if (fromGroup !== -1 && toGroup !== -1) {
                    const moved = moveStudentByAttribute(attr, fromGroup, toGroup);
                    if (moved) {
                        adjusted = true;
                        addDebugLog('BALANCE', `${getAttributeName(attr)}„ÅÆ„Éê„É©„É≥„ÇπË™øÊï¥„ÇíÂÆüÊñΩ`);
                    }
                }
            }
            
            return adjusted;
        }
        
        // Êó©Á®≤Áî∞„ÉªÊÖ∂Êáâ„ÅÆ„Éê„É©„É≥„ÇπË™øÊï¥
        function balanceWasedaKeio() {
            let adjusted = false;
            const universities = ['Êó©Á®≤Áî∞', 'ÊÖ∂Êáâ'];
            
            for (const univ of universities) {
                const distribution = calculateUniversityDistribution(univ);
                if (distribution.total === 0) continue;
                
                const targetDist = calculateTargetDistribution(distribution.total);
                
                // ÊúÄ„ÇÇÂÅè„Å£„Å¶„ÅÑ„Çã„Ç∞„É´„Éº„Éó„ÇíÁâπÂÆö
                let maxDiff = 0;
                let fromGroup = -1;
                let toGroup = -1;
                
                for (let i = 0; i < CONFIG.groupCount; i++) {
                    const current = distribution.byGroup[i];
                    const target = targetDist[i];
                    const diff = current - target;
                    
                    if (Math.abs(diff) > 1) {
                        for (let j = 0; j < CONFIG.groupCount; j++) {
                            if (i === j) continue;
                            const otherDiff = distribution.byGroup[j] - targetDist[j];
                            if (diff > 0 && otherDiff < 0) {
                                maxDiff = Math.abs(diff - otherDiff);
                                fromGroup = i;
                                toGroup = j;
                            }
                        }
                    }
                }
                
                // Ë™øÊï¥ÂÆüË°å
                if (fromGroup !== -1 && toGroup !== -1) {
                    const moved = moveStudentByUniversity(univ, fromGroup, toGroup);
                    if (moved) {
                        adjusted = true;
                        addDebugLog('BALANCE', `${univ}Â§ßÂ≠¶„ÅÆ„Éê„É©„É≥„ÇπË™øÊï¥„ÇíÂÆüÊñΩ`);
                    }
                }
            }
            
            return adjusted;
        }
        
        // „Éò„É´„Éë„ÉºÈñ¢Êï∞
        function calculateCurrentAttributeDistribution(attr) {
            const result = { total: 0, byGroup: [] };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                let count = 0;
                if (attr === 'female') {
                    count = groups[i].students.filter(s => s.gender === 'Â•≥').length;
                } else if (attr === 'science') {
                    count = groups[i].students.filter(s => s.major === 'ÁêÜ').length;
                } else if (attr === 'graduate') {
                    count = groups[i].students.filter(s => s.isGraduate).length;
                }
                result.byGroup.push(count);
                result.total += count;
            }
            
            return result;
        }
        
        function calculateUniversityDistribution(univKeyword) {
            const result = { total: 0, byGroup: [] };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const count = groups[i].students.filter(s => 
                    s.university.includes(univKeyword) || 
                    (univKeyword === 'ÊÖ∂Êáâ' && (s.university.includes('ÊÖ∂Âøú') || s.university.includes('Keio'))) ||
                    (univKeyword === 'Êó©Á®≤Áî∞' && s.university.includes('Waseda'))
                ).length;
                result.byGroup.push(count);
                result.total += count;
            }
            
            return result;
        }
        
        function calculateTargetDistribution(total) {
            const base = Math.floor(total / CONFIG.groupCount);
            const remainder = total % CONFIG.groupCount;
            const distribution = [];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                distribution.push(base + (i < remainder ? 1 : 0));
            }
            
            return distribution;
        }
        
        function moveStudentByAttribute(attr, fromGroup, toGroup) {
            // Êù°‰ª∂„Å´Âêà„ÅÜÂ≠¶Áîü„ÇíÊé¢„Åô
            for (const student of groups[fromGroup].students) {
                let matches = false;
                if (attr === 'female' && student.gender === 'Â•≥') matches = true;
                else if (attr === 'science' && student.major === 'ÁêÜ') matches = true;
                else if (attr === 'graduate' && student.isGraduate) matches = true;
                
                if (matches && canPlaceStudent(student, groups[toGroup].students)) {
                    // ÁßªÂãïÂÆüË°å
                    groups[fromGroup].students = groups[fromGroup].students.filter(s => s !== student);
                    groups[toGroup].students.push(student);
                    student.groupId = toGroup;
                    return true;
                }
            }
            
            return false;
        }
        
        function moveStudentByUniversity(univKeyword, fromGroup, toGroup) {
            for (const student of groups[fromGroup].students) {
                if ((student.university.includes(univKeyword) || 
                    (univKeyword === 'ÊÖ∂Êáâ' && (student.university.includes('ÊÖ∂Âøú') || student.university.includes('Keio'))) ||
                    (univKeyword === 'Êó©Á®≤Áî∞' && student.university.includes('Waseda'))) &&
                    canPlaceStudent(student, groups[toGroup].students)) {
                    
                    // ÁßªÂãïÂÆüË°å
                    groups[fromGroup].students = groups[fromGroup].students.filter(s => s !== student);
                    groups[toGroup].students.push(student);
                    student.groupId = toGroup;
                    return true;
                }
            }
            
            return false;
        }
        
        function getAttributeName(attr) {
            if (attr === 'female') return 'Â•≥ÊÄß';
            if (attr === 'science') return 'ÁêÜÁ≥ª';
            if (attr === 'graduate') return 'Èô¢Áîü';
            return attr;
        }
        
        // ÊúÄÁµÇÁ¢∫Ë™ç
        function performFinalCheck(attributeTargets, tracker, groupTargetSizes) {
            const finalCheck = {
                totalAssigned: 0,
                groupSizes: [],
                attributeDistribution: {
                    female: [],
                    science: [],
                    graduate: []
                }
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                finalCheck.totalAssigned += groups[i].students.length;
                finalCheck.groupSizes.push(groups[i].students.length);
            }
            
            addDebugLog('FINAL', 'ÈÖçÂàÜÂÆå‰∫Ü', finalCheck);
        }
        
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function initializeTracker() {
            return {
                groupCount: CONFIG.groupCount,
                assigned: Array(CONFIG.groupCount).fill(0),
                attributes: {
                    female: Array(CONFIG.groupCount).fill(0),
                    science: Array(CONFIG.groupCount).fill(0),
                    graduate: Array(CONFIG.groupCount).fill(0)
                }
            };
        }
        
        function calculateAttributeTargets() {
            const femaleStudents = students.filter(s => s.gender === 'Â•≥');
            const scienceStudents = students.filter(s => s.major === 'ÁêÜ');
            const graduateStudents = students.filter(s => s.isGraduate);
            
            return {
                female: {
                    total: femaleStudents.length,
                    distribution: calculateDistribution(femaleStudents.length)
                },
                science: {
                    total: scienceStudents.length,
                    distribution: calculateDistribution(scienceStudents.length)
                },
                graduate: {
                    total: graduateStudents.length,
                    distribution: calculateDistribution(graduateStudents.length)
                }
            };
        }
        
        function calculateDistribution(total) {
            const base = Math.floor(total / CONFIG.groupCount);
            const remainder = total % CONFIG.groupCount;
            const distribution = [];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                distribution.push(base + (i < remainder ? 1 : 0));
            }
            
            return distribution;
        }
        
        function calculateGroupSizes(totalStudents, groupCount) {
            const baseSize = Math.floor(totalStudents / groupCount);
            const remainder = totalStudents % groupCount;
            
            const sizes = [];
            for (let i = 0; i < groupCount; i++) {
                sizes.push(baseSize + (i < remainder ? 1 : 0));
            }
            
            return sizes;
        }
        
        function analyzeUniversities() {
            const universityCount = {};
            const studentsByUniversity = {};
            
            students.forEach(student => {
                const univ = student.university;
                if (!universityCount[univ]) {
                    universityCount[univ] = 0;
                    studentsByUniversity[univ] = [];
                }
                universityCount[univ]++;
                studentsByUniversity[univ].push(student);
            });
            
            return {
                universityCount,
                studentsByUniversity
            };
        }
        
        function updateTracker(student, groupId, tracker) {
            tracker.assigned[groupId]++;
            
            if (student.gender === 'Â•≥') {
                tracker.attributes.female[groupId]++;
            }
            if (student.major === 'ÁêÜ') {
                tracker.attributes.science[groupId]++;
            }
            if (student.isGraduate) {
                tracker.attributes.graduate[groupId]++;
            }
        }
        
        // ÁµêÊûúË°®Á§∫
        function displayResults() {
            // Êó©ÊÖ∂„ÅÆÂàÜÂ∏É„ÇíË®àÁÆó
            const wasedaKeioDistribution = calculateWasedaKeioDistribution();
            
            // Êó©ÊÖ∂ÂàÜÂ∏É„ÅÆË°®Á§∫
            let distributionHtml = '';
            if (wasedaKeioDistribution.waseda.total > 0 || wasedaKeioDistribution.keio.total > 0) {
                distributionHtml = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeaa7;">';
                distributionHtml += '<h3 style="margin: 0 0 10px 0; color: #856404;">üè´ Êó©Á®≤Áî∞Â§ßÂ≠¶„ÉªÊÖ∂ÊáâÂ§ßÂ≠¶„ÅÆÂàÜÂ∏ÉÁä∂Ê≥Å</h3>';
                
                if (wasedaKeioDistribution.waseda.total > 0) {
                    distributionHtml += `<p style="margin: 5px 0;">Êó©Á®≤Áî∞Â§ßÂ≠¶: ÂêàË®à${wasedaKeioDistribution.waseda.total}Âêç`;
                    distributionHtml += ` (ÂêÑ„Ç∞„É´„Éº„Éó: ${wasedaKeioDistribution.waseda.distribution.join(', ')})</p>`;
                }
                
                if (wasedaKeioDistribution.keio.total > 0) {
                    distributionHtml += `<p style="margin: 5px 0;">ÊÖ∂ÊáâÂ§ßÂ≠¶: ÂêàË®à${wasedaKeioDistribution.keio.total}Âêç`;
                    distributionHtml += ` (ÂêÑ„Ç∞„É´„Éº„Éó: ${wasedaKeioDistribution.keio.distribution.join(', ')})</p>`;
                }
                
                distributionHtml += '</div>';
            }
            
            // „Çµ„Éû„É™„ÉºË°®Á§∫
            let summaryHtml = distributionHtml + '<div class="stats-grid">';
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                
                summaryHtml += `
                    <div class="stat-card">
                        <div style="font-weight: bold; color: #007bff; margin-bottom: 10px;">„Ç∞„É´„Éº„Éó${i + 1}</div>
                        <div>‰∫∫Êï∞: ${group.students.length}Âêç</div>
                        <div style="font-size: 0.9em; color: #6c757d;">
                            Â•≥ÊÄß${stats.female} / ÁêÜÁ≥ª${stats.science} / Èô¢Áîü${stats.graduate}
                        </div>
                    </div>
                `;
            }
            summaryHtml += '</div>';
            document.getElementById('results-summary').innerHTML = summaryHtml;
        }
        
        // Êó©Á®≤Áî∞„ÉªÊÖ∂Êáâ„ÅÆÂàÜÂ∏É„ÇíË®àÁÆó
        function calculateWasedaKeioDistribution() {
            const result = {
                waseda: { total: 0, distribution: [] },
                keio: { total: 0, distribution: [] }
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const wasedaCount = groups[i].students.filter(s => 
                    s.university.includes('Êó©Á®≤Áî∞') || s.university.includes('Waseda')
                ).length;
                const keioCount = groups[i].students.filter(s => 
                    s.university.includes('ÊÖ∂Êáâ') || s.university.includes('ÊÖ∂Âøú') || s.university.includes('Keio')
                ).length;
                
                result.waseda.distribution.push(wasedaCount);
                result.waseda.total += wasedaCount;
                result.keio.distribution.push(keioCount);
                result.keio.total += keioCount;
            }
            
            return result;
        }
        
        // „Ç∞„É´„Éº„ÉóÁµ±Ë®àË®àÁÆó
        function calculateGroupStats(students) {
            return {
                female: students.filter(s => s.gender === 'Â•≥').length,
                science: students.filter(s => s.major === 'ÁêÜ').length,
                graduate: students.filter(s => s.isGraduate).length
            };
        }
        
        // Ë©≥Á¥∞ÁµêÊûúË°®Á§∫
        function showDetailedResults() {
            let html = '<div class="group-grid">';
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                html += `
                    <div class="group-card">
                        <div class="group-header">„Ç∞„É´„Éº„Éó${i + 1} (${group.students.length}Âêç)</div>
                        <div>
                `;
                
                group.students.forEach(s => {
                    html += `
                        <div class="student-item">
                            ${s.name} - ${s.university}
                            ${s.department ? `(${s.department})` : ''}
                            ${s.isGraduate ? '„ÄêÈô¢„Äë' : ''}
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            document.getElementById('groups-display').innerHTML = html;
        }
        
        // ExcelÂá∫Âäõ
        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // „Çµ„Éû„É™„Éº„Ç∑„Éº„Éà
            const summaryData = [
                ['„Ç∞„É´„Éº„ÉóÈÖçÂàÜÁµêÊûú„Çµ„Éû„É™„Éº'],
                ['ÁîüÊàêÊó•ÊôÇ', new Date().toLocaleString()],
                [''],
                ['„Ç∞„É´„Éº„Éó', '‰∫∫Êï∞', 'Â•≥ÊÄß', 'ÁêÜÁ≥ª', 'Èô¢Áîü']
            ];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                summaryData.push([
                    `„Ç∞„É´„Éº„Éó${i + 1}`,
                    group.students.length,
                    stats.female,
                    stats.science,
                    stats.graduate
                ]);
            }
            
            const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWS, '„Çµ„Éû„É™„Éº');
            
            // Ë©≥Á¥∞„Ç∑„Éº„Éà
            const detailData = [['„Ç∞„É´„Éº„Éó']];
            
            // ÂÖÉ„Éá„Éº„Çø„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„ÇíËøΩÂä†
            headers.forEach(header => {
                detailData[0].push(header);
            });
            
            // Â≠¶Áîü„Éá„Éº„Çø„ÇíËøΩÂä†
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                group.students.forEach(student => {
                    const row = [`„Ç∞„É´„Éº„Éó${i + 1}`];
                    student.originalData.forEach(cell => {
                        row.push(cell);
                    });
                    detailData.push(row);
                });
            }
            
            const detailWS = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, detailWS, 'Ë©≥Á¥∞');
            
            // „Éï„Ç°„Ç§„É´‰øùÂ≠ò
            const date = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `„Ç∞„É´„Éº„ÉóÈÖçÂàÜÁµêÊûú_${date}.xlsx`);
        }
        
        // HTMLÂá∫ÂäõÈñ¢Êï∞„Çí‰øÆÊ≠£
        function downloadHTML() {
            // HTMLÁîüÊàêÊôÇ„Å´JSON„Éá„Éº„Çø„ÇíÂÆâÂÖ®„Å´„Ç®„É≥„Ç≥„Éº„Éâ
            const groupsJSON = JSON.stringify(groups);
            // CONFIG„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí„Ç∑„É≥„Éó„É´„Å™ÂΩ¢Âºè„Å´Â§âÊèõ
            const configData = {
                groupCount: CONFIG.groupCount,
                maxUniversityPerGroup: CONFIG.maxUniversityPerGroup
            };
            const configJSON = JSON.stringify(configData);
            // ÂÖÉ„Éá„Éº„Çø„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±„ÇÇÊ∏°„Åô
            const headersJSON = JSON.stringify(headers);
            
            // Blob API„Çí‰ΩøÁî®„Åó„Å¶HTML„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê
            const blob = new Blob([generateEditableHTML(groupsJSON, configJSON, headersJSON)], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `„Ç∞„É´„Éº„ÉóÈÖçÂàÜÁµêÊûú_${new Date().toISOString().slice(0, 10)}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Á∑®ÈõÜÂèØËÉΩ„Å™HTML„ÇíÁîüÊàêÔºà‰øÆÊ≠£ÁâàÔºâ
        function generateEditableHTML(groupsJSON, configJSON, headersJSON) {
            // HTML„Éï„Ç°„Ç§„É´ÂÖ®‰Ωì„ÇíÊñáÂ≠óÂàó„Å®„Åó„Å¶ÊßãÁØâ
            const html = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>„Ç∞„É´„Éº„ÉóÈÖçÂàÜÁµêÊûú - Á∑®ÈõÜÂèØËÉΩÁâà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>
    <style>
        /* „Åì„Åì„Å´„Çπ„Çø„Ç§„É´„ÇíË®òËø∞ */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .control-panel { position: fixed; top: 20px; right: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-width: 250px; }
        .control-button { display: block; width: 100%; padding: 10px; margin: 5px 0; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .control-button:hover { background: #2980b9; }
        .control-button.excel { background: #27ae60; }
        .control-button.excel:hover { background: #229954; }
        .control-button.undo { background: #e74c3c; }
        .control-button.undo:hover { background: #c0392b; }
        .summary { margin-bottom: 40px; }
        .summary table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; }
        .summary th, .summary td { padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; }
        .summary th { background: #f8f9fa; font-weight: bold; color: #495057; }
        .groups-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .group-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: all 0.3s; }
        .group-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
        .group-title { font-size: 1.2em; font-weight: bold; color: #007bff; margin-bottom: 10px; }
        .group-stats { font-size: 0.9em; color: #6c757d; margin-bottom: 15px; }
        .student-list { min-height: 100px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 2px dashed transparent; transition: all 0.3s; }
        .student-list.drag-over { background: #e3f2fd; border-color: #2196f3; }
        .student-item { padding: 10px; margin: 5px 0; background: white; border-radius: 6px; cursor: move; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .student-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .student-item.dragging { opacity: 0.5; }
        .student-name { font-weight: bold; color: #333; }
        .student-info { font-size: 0.85em; color: #666; margin-top: 4px; }
        @media (max-width: 768px) {
            .control-panel { position: static; margin-bottom: 20px; max-width: 100%; }
            .groups-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>„Ç∞„É´„Éº„ÉóÈÖçÂàÜÁµêÊûú - ÊâãÂãïË™øÊï¥ÂèØËÉΩÁâà</h1>
        
        <div class="control-panel">
            <h3 style="margin: 0 0 15px 0; font-size: 16px;">ÊâãÂãïË™øÊï¥„ÉÑ„Éº„É´</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                Â≠¶Áîü„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÁßªÂãï„Åß„Åç„Åæ„Åô
            </p>
            <button class="control-button undo" onclick="undoLastMove()" id="undoBtn" disabled>
                ÂÖÉ„Å´Êàª„Åô
            </button>
            <button class="control-button excel" onclick="downloadExcel()">
                Excel„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            </button>
            <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
            <div id="moveHistory" style="font-size: 12px; color: #666; max-height: 200px; overflow-y: auto;">
                <strong>ÁßªÂãïÂ±•Ê≠¥:</strong>
                <div id="historyList"><em>„Åæ„Å†ÁßªÂãï„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</em></div>
            </div>
        </div>
        
        <div id="summary-container"></div>
        <div id="groups-container"></div>
    </div>
    
    <script>
        // „Éá„Éº„Çø„ÅÆÂàùÊúüÂåñ
        let groups = ${groupsJSON};
        const CONFIG = ${configJSON};
        const headers = ${headersJSON};
        let moveHistory = [];
        let draggedStudent = null;
        let sourceGroup = null;
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÆüË°å
        window.addEventListener('DOMContentLoaded', function() {
            renderGroups();
            renderSummary();
        });
        
        // „Ç∞„É´„Éº„ÉóË°®Á§∫
        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.className = 'groups-container';
            container.innerHTML = '';
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card';
                groupCard.innerHTML = \`
                    <div class="group-title">„Ç∞„É´„Éº„Éó\${i + 1} (\${group.students.length}Âêç)</div>
                    <div class="group-stats">
                        Â•≥ÊÄß\${stats.female}Âêç / ÁêÜÁ≥ª\${stats.science}Âêç / Èô¢Áîü\${stats.graduate}Âêç
                    </div>
                    <div class="student-list" data-group="\${i}">
                        \${group.students.map(s => \`
                            <div class="student-item" draggable="true" 
                                 data-student='\${JSON.stringify(s).replace(/'/g, "&#39;")}'
                                 data-group="\${i}">
                                <div class="student-name">\${s.name}</div>
                                <div class="student-info">
                                    \${s.university}\${s.department ? \` (\${s.department})\` : ''}
                                    \${s.isGraduate ? ' „ÄêÈô¢„Äë' : ''}
                                    / \${s.gender} / \${s.major}
                                </div>
                            </div>
                        \`).join('')}
                    </div>
                \`;
                
                container.appendChild(groupCard);
            }
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            setupDragAndDrop();
        }
        
        // „Çµ„Éû„É™„ÉºË°®Á§∫
        function renderSummary() {
            const container = document.getElementById('summary-container');
            container.className = 'summary';
            
            let html = '<h2>„Ç∞„É´„Éº„ÉóÂà•Â±ûÊÄß„Çµ„Éû„É™„Éº</h2><table><thead><tr>';
            html += '<th>„Ç∞„É´„Éº„Éó</th><th>‰∫∫Êï∞</th><th>Â•≥ÊÄß</th><th>Áî∑ÊÄß</th>';
            html += '<th>ÁêÜÁ≥ª</th><th>ÊñáÁ≥ª</th><th>Èô¢Áîü</th><th>Â≠¶ÈÉ®Áîü</th>';
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                html += \`<tr>
                    <td>„Ç∞„É´„Éº„Éó\${i + 1}</td>
                    <td>\${group.students.length}</td>
                    <td>\${stats.female}</td>
                    <td>\${group.students.length - stats.female}</td>
                    <td>\${stats.science}</td>
                    <td>\${group.students.length - stats.science}</td>
                    <td>\${stats.graduate}</td>
                    <td>\${group.students.length - stats.graduate}</td>
                </tr>\`;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆË®≠ÂÆö
        function setupDragAndDrop() {
            // Â≠¶Áîü„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Ç§„Éô„É≥„Éà
            document.querySelectorAll('.student-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
            
            // Â≠¶Áîü„É™„Çπ„Éà„ÅÆ„Ç§„Éô„É≥„Éà
            document.querySelectorAll('.student-list').forEach(list => {
                list.addEventListener('dragover', allowDrop);
                list.addEventListener('drop', handleDrop);
                list.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
        function handleDragStart(e) {
            draggedStudent = JSON.parse(e.target.dataset.student);
            sourceGroup = parseInt(e.target.dataset.group);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        // „Éâ„É≠„ÉÉ„ÉóË®±ÂèØ
        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        // „Éâ„É©„ÉÉ„Ç∞Èõ¢ËÑ±
        function handleDragLeave(e) {
            if (e.target.classList.contains('student-list')) {
                e.target.classList.remove('drag-over');
            }
        }
        
        // „Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ
        function handleDrop(e) {
            e.preventDefault();
            const targetGroup = parseInt(e.currentTarget.dataset.group);
            e.currentTarget.classList.remove('drag-over');
            
            if (sourceGroup === targetGroup) return;
            
            // ÁßªÂãïÂ±•Ê≠¥„Çí‰øùÂ≠ò
            moveHistory.push({
                student: draggedStudent,
                from: sourceGroup,
                to: targetGroup,
                timestamp: new Date()
            });
            
            // „Ç∞„É´„Éº„Éó„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            groups[sourceGroup].students = groups[sourceGroup].students.filter(
                s => s.name !== draggedStudent.name || s.university !== draggedStudent.university
            );
            
            groups[targetGroup].students.push(draggedStudent);
            
            // UI„ÇíÊõ¥Êñ∞
            renderGroups();
            renderSummary();
            updateMoveHistory();
            
            // Undo„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
            document.getElementById('undoBtn').disabled = false;
        }
        
        // ÁßªÂãï„ÇíÂÖÉ„Å´Êàª„Åô
        function undoLastMove() {
            if (moveHistory.length === 0) return;
            
            const lastMove = moveHistory.pop();
            
            // ÁßªÂãï„ÇíÂÖÉ„Å´Êàª„Åô
            groups[lastMove.to].students = groups[lastMove.to].students.filter(
                s => s.name !== lastMove.student.name || s.university !== lastMove.student.university
            );
            
            groups[lastMove.from].students.push(lastMove.student);
            
            // UI„ÇíÊõ¥Êñ∞
            renderGroups();
            renderSummary();
            updateMoveHistory();
            
            // Â±•Ê≠¥„ÅåÁ©∫„Å´„Å™„Å£„Åü„ÇâUndo„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            if (moveHistory.length === 0) {
                document.getElementById('undoBtn').disabled = true;
            }
        }
        
        // ÁßªÂãïÂ±•Ê≠¥„ÇíÊõ¥Êñ∞
        function updateMoveHistory() {
            const historyList = document.getElementById('historyList');
            
            if (moveHistory.length === 0) {
                historyList.innerHTML = '<em>„Åæ„Å†ÁßªÂãï„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</em>';
                return;
            }
            
            historyList.innerHTML = moveHistory.slice(-5).reverse().map(move => \`
                <div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                    \${move.student.name} („Ç∞„É´„Éº„Éó\${move.from + 1} ‚Üí \${move.to + 1})
                </div>
            \`).join('');
        }
        
        // „Ç∞„É´„Éº„ÉóÁµ±Ë®àË®àÁÆó
        function calculateGroupStats(students) {
            return {
                female: students.filter(s => s.gender === 'Â•≥').length,
                science: students.filter(s => s.major === 'ÁêÜ').length,
                graduate: students.filter(s => s.isGraduate).length
            };
        }
        
        // ExcelÂá∫Âäõ
        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // „Çµ„Éû„É™„Éº„Ç∑„Éº„Éà
            const summaryData = [
                ['„Ç∞„É´„Éº„ÉóÈÖçÂàÜÁµêÊûú„Çµ„Éû„É™„Éº (ÊâãÂãïË™øÊï¥Ê∏à„Åø)'],
                ['ÁîüÊàêÊó•ÊôÇ', new Date().toLocaleString()],
                ['ÁßªÂãïÂõûÊï∞', moveHistory.length + 'Âõû'],
                [''],
                ['„Ç∞„É´„Éº„Éó', '‰∫∫Êï∞', 'Â•≥ÊÄß', 'ÁêÜÁ≥ª', 'Èô¢Áîü']
            ];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                summaryData.push([
                    '„Ç∞„É´„Éº„Éó' + (i + 1),
                    group.students.length,
                    stats.female,
                    stats.science,
                    stats.graduate
                ]);
            }
            
            const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWS, '„Çµ„Éû„É™„Éº');
            
            // Ë©≥Á¥∞„Ç∑„Éº„ÉàÔºàÂÖÉ„Éá„Éº„Çø„ÅÆÂÖ®Âàó„ÇíÂê´„ÇÄÔºâ
            const detailData = [['„Ç∞„É´„Éº„Éó']];
            
            // ÂÖÉ„Éá„Éº„Çø„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„ÇíËøΩÂä†
            if (headers && headers.length > 0) {
                headers.forEach(header => {
                    detailData[0].push(header);
                });
            } else {
                // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂü∫Êú¨ÊÉÖÂ†±„ÅÆ„Åø
                detailData[0].push('Ê∞èÂêç', 'Â§ßÂ≠¶', 'Â≠¶ÈÉ®', 'ÊñáÁêÜ', 'ÊÄßÂà•', 'Â≠¶Ê†°Âå∫ÂàÜ');
            }
            
            // Â≠¶Áîü„Éá„Éº„Çø„ÇíËøΩÂä†
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                group.students.forEach(student => {
                    const row = ['„Ç∞„É´„Éº„Éó' + (i + 1)];
                    
                    // originalData„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
                    if (student.originalData && student.originalData.length > 0) {
                        student.originalData.forEach(cell => {
                            row.push(cell);
                        });
                    } else {
                        // originalData„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂü∫Êú¨ÊÉÖÂ†±„ÅÆ„Åø
                        row.push(
                            student.name,
                            student.university || '',
                            student.department || '',
                            student.major === 'ÁêÜ' ? 'ÁêÜÁ≥ª' : 'ÊñáÁ≥ª',
                            student.gender === 'Â•≥' ? 'Â•≥ÊÄß' : 'Áî∑ÊÄß',
                            student.isGraduate ? 'Â§ßÂ≠¶Èô¢' : 'Â§ßÂ≠¶Áîü'
                        );
                    }
                    
                    detailData.push(row);
                });
            }
            
            const detailWS = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, detailWS, 'Ë©≥Á¥∞');
            
            // „Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            const date = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, '„Ç∞„É´„Éº„ÉóÈÖçÂàÜÁµêÊûú_Ë™øÊï¥Ê∏à„Åø_' + date + '.xlsx');
        }
    <\/script>
</body>
</html>`;
            
            return html;
        }
        
        // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
        function addDebugLog(step, message, details = null) {
            debugLog.push({
                step,
                message,
                details,
                timestamp: new Date().toISOString()
            });
        }
        
        function showDebugLog() {
            const logDiv = document.getElementById('debug-log');
            logDiv.style.display = logDiv.style.display === 'none' ? 'block' : 'none';
            
            if (logDiv.style.display === 'block') {
                let html = '<h3>„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞</h3>';
                debugLog.forEach(entry => {
                    html += `<div class="debug-entry">
                        <strong>[${entry.step}]</strong> ${entry.message}
                        ${entry.details ? `<br>Ë©≥Á¥∞: ${JSON.stringify(entry.details)}` : ''}
                    </div>`;
                });
                logDiv.innerHTML = html;
            }
        }
        
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'flex';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>