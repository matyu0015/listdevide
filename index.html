<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelå­¦ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†ã‚·ã‚¹ãƒ†ãƒ  - å®Œå…¨ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .step-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 15px;
        }
        
        .step-title {
            font-size: 1.4em;
            color: #333;
        }
        
        .file-input-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input-area:hover {
            background: #e3f2fd;
            border-color: #0056b3;
        }
        
        .file-input-area.dragover {
            background: #e3f2fd;
            border-color: #0056b3;
            transform: scale(1.02);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .mapping-item {
            display: flex;
            flex-direction: column;
        }
        
        .mapping-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }
        
        .mapping-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 1em;
            cursor: pointer;
        }
        
        .button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        
        .button-primary {
            background: #007bff;
            color: white;
        }
        
        .button-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        .button-success {
            background: #28a745;
            color: white;
        }
        
        .button-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        
        .button-warning {
            background: #ffc107;
            color: #333;
        }
        
        .button-info {
            background: #17a2b8;
            color: white;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .preview-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            align-items: center;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #c8e6c9;
        }
        
        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        
        .results-container {
            display: none;
        }
        
        .group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .group-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        
        .group-header {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #007bff;
        }
        
        .student-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            display: none;
        }
        
        .debug-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-left: 3px solid #007bff;
            background: white;
        }
        
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .draggable {
            cursor: move;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .drag-over {
            background-color: #e3f2fd !important;
            border: 2px dashed #2196f3;
        }
        
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 250px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }
            
            .step-container {
                padding: 20px;
            }
            
            .mapping-grid {
                grid-template-columns: 1fr;
            }
            
            .group-grid {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                position: static;
                margin-bottom: 20px;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š Excelå­¦ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã§14ã‚°ãƒ«ãƒ¼ãƒ—ã«å‡ç­‰é…åˆ†ã—ã¾ã™</p>
    </div>
    
    <div class="container">
        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
        <div class="step-container">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2 class="step-title">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h2>
            </div>
            
            <div class="file-input-area" id="dropZone">
                <div class="file-icon">ğŸ“</div>
                <p style="font-size: 1.2em; margin-bottom: 10px;">
                    ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                </p>
                <p style="color: #6c757d;">
                    å¯¾å¿œå½¢å¼: .xlsx, .xls
                </p>
                <input type="file" id="excel-file" accept=".xlsx,.xls">
            </div>
            
            <div id="file-info" style="margin-top: 20px; display: none;">
                <p style="color: #28a745;">
                    âœ… ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: <strong id="file-name"></strong>
                </p>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: åˆ—ãƒãƒƒãƒ”ãƒ³ã‚° -->
        <div id="mapping-section" class="step-container" style="display: none;">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2 class="step-title">ãƒ‡ãƒ¼ã‚¿é …ç›®ã®è¨­å®š</h2>
            </div>
            
            <div class="mapping-grid">
                <div class="mapping-item">
                    <label class="mapping-label">æ°ååˆ— <span style="color: red;">*</span></label>
                    <select id="col-name" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">å¤§å­¦åˆ— <span style="color: red;">*</span></label>
                    <select id="col-university" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">å­¦éƒ¨åˆ—</label>
                    <select id="col-department" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">æ–‡ç†åˆ— <span style="color: red;">*</span></label>
                    <select id="col-major" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">æ€§åˆ¥åˆ— <span style="color: red;">*</span></label>
                    <select id="col-gender" class="mapping-select"></select>
                </div>
                <div class="mapping-item">
                    <label class="mapping-label">å¤§å­¦ç”Ÿ/å¤§å­¦é™¢åˆ— <span style="color: red;">*</span></label>
                    <select id="col-graduate" class="mapping-select"></select>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="button button-primary" onclick="previewData()">
                    ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
                <button class="button button-info" onclick="autoDetectColumns()">
                    è‡ªå‹•æ¤œå‡º
                </button>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div id="preview-section" class="step-container" style="display: none;">
            <div class="step-header">
                <div class="step-number">3</div>
                <h2 class="step-title">ãƒ‡ãƒ¼ã‚¿ç¢ºèª</h2>
            </div>
            
            <div id="preview-stats" class="stats-grid"></div>
            
            <div id="preview-table-container" style="overflow-x: auto;"></div>
            
            <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <div style="margin-bottom: 15px;">
                    <label for="group-count-select" style="font-weight: 600; margin-right: 10px;">ã‚°ãƒ«ãƒ¼ãƒ—æ•°:</label>
                    <select id="group-count-select" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; cursor: pointer;">
                        <!-- 1ã€œ30ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ -->
                    </select>
                    <span style="margin-left: 10px; color: #6c757d;">ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 14ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰</span>
                </div>
                <button class="button button-success" onclick="executeAllocation()">
                    ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†ã‚’å®Ÿè¡Œ
                </button>
                <button class="button button-warning" onclick="showDebugLog()">
                    ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¡¨ç¤º
                </button>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—4: çµæœ -->
        <div id="results-section" class="step-container results-container">
            <div class="step-header">
                <div class="step-number">4</div>
                <h2 class="step-title">é…åˆ†çµæœ</h2>
            </div>
            
            <div id="results-summary"></div>
            
            <div style="margin: 20px 0;">
                <button class="button button-success" onclick="downloadExcel()">
                    ğŸ“¥ Excelå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
                <button class="button button-primary" onclick="downloadHTML()">
                    ğŸ“„ HTMLå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆç·¨é›†å¯èƒ½ï¼‰
                </button>
                <button class="button button-info" onclick="showDetailedResults()">
                    è©³ç´°è¡¨ç¤º
                </button>
            </div>
            
            <div id="groups-display"></div>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="status-message" class="status-message"></div>
        
        <!-- ãƒ­ãƒ¼ãƒ€ãƒ¼ -->
        <div id="loader" class="loader">
            <div class="loader-spinner"></div>
            <p style="margin-top: 20px;">å‡¦ç†ä¸­...</p>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° -->
        <div id="debug-log" class="debug-log"></div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let workbook = null;
        let excelData = null;
        let headers = [];
        let students = [];
        let groups = {};
        let debugLog = [];
        let originalData = [];
        let columnMapping = {};
        
        const CONFIG = {
            groupCount: 14,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            get maxUniversityPerGroup() {
                // ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã«å¿œã˜ã¦å‹•çš„ã«è¨ˆç®—
                // ã‚°ãƒ«ãƒ¼ãƒ—æ•°ãŒå°‘ãªã„å ´åˆã¯åˆ¶é™ã‚’ç·©å’Œ
                if (this.groupCount <= 5) return 10;
                if (this.groupCount <= 10) return 6;
                if (this.groupCount <= 15) return 4;
                return 3;
            }
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('excel-file');
            
            // ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
            initializeGroupCountSelect();
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            dropZone.addEventListener('click', function() {
                fileInput.click();
            });
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
            fileInput.addEventListener('change', function(event) {
                handleFileSelect(event);
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¿½åŠ /å‰Šé™¤
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
            dropZone.addEventListener('drop', handleDrop, false);
        });
        
        // ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
        function initializeGroupCountSelect() {
            const select = document.getElementById('group-count-select');
            if (!select) return;
            
            // 1ã€œ30ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            for (let i = 1; i <= 30; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 'ã‚°ãƒ«ãƒ¼ãƒ—';
                if (i === 14) {
                    option.selected = true;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                }
                select.appendChild(option);
            }
            
            // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            select.addEventListener('change', function() {
                CONFIG.groupCount = parseInt(this.value);
                const maxUniv = CONFIG.maxUniversityPerGroup;
                showStatus(`ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã‚’${CONFIG.groupCount}ã«å¤‰æ›´ã—ã¾ã—ãŸï¼ˆåŒä¸€å¤§å­¦ä¸Šé™: ${maxUniv}å/ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰`, 'info');
            });
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²ã
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        function highlight(e) {
            document.getElementById('dropZone').classList.add('dragover');
        }
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
        function unhighlight(e) {
            document.getElementById('dropZone').classList.remove('dragover');
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsx ã¾ãŸã¯ .xlsï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-info').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheet = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheet];
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (excelData && excelData.length > 0) {
                        headers = excelData[0];
                        originalData = excelData.slice(1);
                        setupColumnMapping();
                        document.getElementById('mapping-section').style.display = 'block';
                        showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚åˆ—ã®è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚', 'info');
                    }
                } catch (error) {
                    showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š
        function setupColumnMapping() {
            const selects = ['col-name', 'col-university', 'col-department', 'col-major', 'col-gender', 'col-graduate'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header || `åˆ—${index + 1}`;
                    select.appendChild(option);
                });
            });
        }
        
        // è‡ªå‹•æ¤œå‡º
        function autoDetectColumns() {
            const mappings = {
                'col-name': ['æ°å', 'åå‰', 'Name', 'å§“å'],
                'col-university': ['å¤§å­¦', 'å¤§å­¦å', 'University', 'å­¦æ ¡'],
                'col-department': ['å­¦éƒ¨', 'å­¦ç§‘', 'Department', 'å°‚æ”»'],
                'col-major': ['æ–‡ç†', 'æ–‡ç³»ç†ç³»', 'å°‚æ”»åŒºåˆ†', 'Major'],
                'col-gender': ['æ€§åˆ¥', 'Gender', 'ç”·å¥³'],
                'col-graduate': ['å¤§å­¦ç”Ÿ/å¤§å­¦é™¢', 'å­¦éƒ¨/å¤§å­¦é™¢', 'å­¦æ ¡åŒºåˆ†', 'Graduate']
            };
            
            for (const [selectId, keywords] of Object.entries(mappings)) {
                const select = document.getElementById(selectId);
                for (let i = 0; i < headers.length; i++) {
                    const header = headers[i] ? headers[i].toString() : '';
                    if (keywords.some(keyword => header.includes(keyword))) {
                        select.value = i;
                        break;
                    }
                }
            }
            
            showStatus('è‡ªå‹•æ¤œå‡ºã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'info');
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewData() {
            const nameCol = document.getElementById('col-name').value;
            const univCol = document.getElementById('col-university').value;
            const majorCol = document.getElementById('col-major').value;
            const genderCol = document.getElementById('col-gender').value;
            const gradCol = document.getElementById('col-graduate').value;
            
            if (!nameCol || !univCol || !majorCol || !genderCol || !gradCol) {
                showStatus('å¿…é ˆé …ç›®ï¼ˆ*ï¼‰ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä¿å­˜
            columnMapping = {
                name: parseInt(nameCol),
                university: parseInt(univCol),
                department: document.getElementById('col-department').value ? parseInt(document.getElementById('col-department').value) : null,
                major: parseInt(majorCol),
                gender: parseInt(genderCol),
                graduate: parseInt(gradCol)
            };
            
            // ãƒ‡ãƒ¼ã‚¿è§£æ
            students = [];
            originalData.forEach((row, index) => {
                if (row[columnMapping.name]) {
                    students.push({
                        id: index,
                        name: row[columnMapping.name].toString().trim(),
                        university: row[columnMapping.university] || 'æœªè¨­å®š',
                        department: columnMapping.department !== null ? (row[columnMapping.department] || '') : '',
                        major: parseMajor(row[columnMapping.major]),
                        gender: parseGender(row[columnMapping.gender]),
                        isGraduate: isGraduate(row[columnMapping.graduate]),
                        originalData: row,
                        assigned: false,
                        groupId: null
                    });
                }
            });
            
            // çµ±è¨ˆè¡¨ç¤º
            displayPreviewStats();
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
            displayPreviewTable();
            
            document.getElementById('preview-section').style.display = 'block';
            showStatus(`${students.length}åã®å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã—ãŸ`, 'success');
        }
        
        // æ–‡ç†åˆ¤å®š
        function parseMajor(value) {
            if (!value) return 'æ–‡';
            const str = value.toString();
            if (str.includes('ç†') || str === 'ç†ç³»') return 'ç†';
            if (str.includes('æ–‡') || str === 'æ–‡ç³»') return 'æ–‡';
            return 'æ–‡';
        }
        
        // æ€§åˆ¥åˆ¤å®š
        function parseGender(value) {
            if (!value) return 'ä¸æ˜';
            const str = value.toString();
            if (str === 'ç”·' || str === 'ç”·æ€§' || str === 'M' || str === 'm') return 'ç”·';
            if (str === 'å¥³' || str === 'å¥³æ€§' || str === 'F' || str === 'f') return 'å¥³';
            return 'ä¸æ˜';
        }
        
        // å¤§å­¦é™¢åˆ¤å®š
        function isGraduate(value) {
            if (!value) return false;
            const str = value.toString();
            return str.includes('é™¢') || str === 'å¤§å­¦é™¢' || str === 'Graduate';
        }
        
        // çµ±è¨ˆè¡¨ç¤º
        function displayPreviewStats() {
            const stats = {
                total: students.length,
                female: students.filter(s => s.gender === 'å¥³').length,
                male: students.filter(s => s.gender === 'ç”·').length,
                science: students.filter(s => s.major === 'ç†').length,
                humanities: students.filter(s => s.major === 'æ–‡').length,
                graduate: students.filter(s => s.isGraduate).length,
                undergraduate: students.filter(s => !s.isGraduate).length
            };
            
            document.getElementById('preview-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">ç·å­¦ç”Ÿæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.female}</div>
                    <div class="stat-label">å¥³æ€§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.male}</div>
                    <div class="stat-label">ç”·æ€§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.science}</div>
                    <div class="stat-label">ç†ç³»</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.humanities}</div>
                    <div class="stat-label">æ–‡ç³»</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.graduate}</div>
                    <div class="stat-label">å¤§å­¦é™¢ç”Ÿ</div>
                </div>
            `;
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
        function displayPreviewTable() {
            let html = '<table class="preview-table">';
            html += '<thead><tr><th>æ°å</th><th>å¤§å­¦</th><th>å­¦éƒ¨</th><th>æ–‡ç†</th><th>æ€§åˆ¥</th><th>å­¦æ ¡åŒºåˆ†</th></tr></thead>';
            html += '<tbody>';
            
            const displayCount = Math.min(10, students.length);
            for (let i = 0; i < displayCount; i++) {
                const s = students[i];
                html += `<tr>
                    <td>${s.name}</td>
                    <td>${s.university}</td>
                    <td>${s.department || '-'}</td>
                    <td>${s.major}</td>
                    <td>${s.gender}</td>
                    <td>${s.isGraduate ? 'å¤§å­¦é™¢' : 'å¤§å­¦ç”Ÿ'}</td>
                </tr>`;
            }
            
            if (students.length > displayCount) {
                html += `<tr><td colspan="6" style="text-align: center; color: #6c757d;">... ä»– ${students.length - displayCount} å</td></tr>`;
            }
            
            html += '</tbody></table>';
            document.getElementById('preview-table-container').innerHTML = html;
        }
        
        // é…åˆ†å®Ÿè¡Œ
        function executeAllocation() {
            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—æ•°ã‚’å–å¾—
            const selectedGroupCount = document.getElementById('group-count-select').value;
            CONFIG.groupCount = parseInt(selectedGroupCount);
            
            showLoader(true);
            debugLog = [];
            
            setTimeout(() => {
                try {
                    allocateStudents();
                    displayResults();
                    showStatus(`${CONFIG.groupCount}ã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®é…åˆ†ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');
                    document.getElementById('results-section').style.display = 'block';
                } catch (error) {
                    showStatus('é…åˆ†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                    console.error(error);
                } finally {
                    showLoader(false);
                }
            }, 100);
        }
        
        // å­¦ç”Ÿé…åˆ†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆkintoneç‰ˆã¨åŒã˜ï¼‰
        function allocateStudents() {
            // ã‚°ãƒ«ãƒ¼ãƒ—åˆæœŸåŒ–
            groups = {};
            for (let i = 0; i < CONFIG.groupCount; i++) {
                groups[i] = {
                    id: i,
                    students: []
                };
            }
            
            // å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            students.forEach(s => {
                s.assigned = false;
                s.groupId = null;
            });
            
            const tracker = initializeTracker();
            const attributeTargets = calculateAttributeTargets();
            const universityInfo = analyzeUniversities();
            
            // ã‚¹ãƒ†ãƒƒãƒ—1: ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®ç›®æ¨™äººæ•°
            const groupTargetSizes = calculateGroupSizes(students.length, CONFIG.groupCount);
            
            // ã‚¹ãƒ†ãƒƒãƒ—1.5: æ—©ç¨²ç”°å¤§å­¦ã¨æ…¶æ‡‰å¤§å­¦ã®å­¦ç”Ÿã‚’å„ªå…ˆçš„ã«å‡ç­‰é…åˆ†
            addDebugLog('STEP1.5', 'æ—©ç¨²ç”°å¤§å­¦ãƒ»æ…¶æ‡‰å¤§å­¦ã®å„ªå…ˆé…åˆ†ã‚’é–‹å§‹');
            allocatePriorityUniversities(tracker, groupTargetSizes);
            checkAndFixStep('STEP1.5', 'æ—©æ…¶å„ªå…ˆé…åˆ†å¾Œ', attributeTargets, tracker, groupTargetSizes);
            
            // ã‚¹ãƒ†ãƒƒãƒ—2: å±æ€§ã”ã¨ã«å‡ç­‰é…åˆ†
            addDebugLog('STEP2', 'å±æ€§åˆ¥é…åˆ†ã‚’é–‹å§‹');
            allocateByAttributesEvenly(attributeTargets, tracker, groupTargetSizes);
            checkAndFixStep('STEP2', 'å±æ€§åˆ¥é…åˆ†å¾Œ', attributeTargets, tracker, groupTargetSizes);
            
            // ã‚¹ãƒ†ãƒƒãƒ—3: å¤§å­¦ã®é‡è¤‡åˆ¶ç´„ã‚’å‡¦ç†
            addDebugLog('STEP3', 'å¤§å­¦åˆ¶ç´„å‡¦ç†ã‚’é–‹å§‹');
            handleUniversityConstraintsImproved(universityInfo, tracker, groupTargetSizes);
            checkAndFixStep('STEP3', 'å¤§å­¦åˆ¶ç´„å‡¦ç†å¾Œ', attributeTargets, tracker, groupTargetSizes);
            
            // ã‚¹ãƒ†ãƒƒãƒ—4: æ®‹ã‚Šã®å­¦ç”Ÿã‚’å‡ç­‰é…ç½®
            addDebugLog('STEP4', 'æ®‹ã‚Šå­¦ç”Ÿé…ç½®ã‚’é–‹å§‹');
            allocateRemainingEvenly(tracker, groupTargetSizes);
            checkAndFixStep('STEP4', 'æ®‹ã‚Šå­¦ç”Ÿé…ç½®å¾Œ', attributeTargets, tracker, groupTargetSizes);
            
            // ã‚¹ãƒ†ãƒƒãƒ—5: æœ€çµ‚èª¿æ•´
            addDebugLog('STEP5', 'æœ€çµ‚èª¿æ•´ã‚’é–‹å§‹');
            finalAdjustment(tracker, attributeTargets, groupTargetSizes);
            
            // ã‚¹ãƒ†ãƒƒãƒ—6: å¾¹åº•çš„ãªæœ€çµ‚ãƒã‚§ãƒƒã‚¯ã¨èª¿æ•´
            addDebugLog('STEP6', 'æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•èª¿æ•´ã‚’é–‹å§‹');
            performComprehensiveFinalCheck(attributeTargets, tracker, groupTargetSizes);
            
            // æœ€çµ‚ç¢ºèª
            performFinalCheck(attributeTargets, tracker, groupTargetSizes);
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†é¡
        function categorizeStudents() {
            return {
                'å¥³æ€§ç†ç³»é™¢ç”Ÿ': students.filter(s => !s.assigned && s.gender === 'å¥³' && s.major === 'ç†' && s.isGraduate),
                'å¥³æ€§ç†ç³»å­¦éƒ¨': students.filter(s => !s.assigned && s.gender === 'å¥³' && s.major === 'ç†' && !s.isGraduate),
                'å¥³æ€§æ–‡ç³»é™¢ç”Ÿ': students.filter(s => !s.assigned && s.gender === 'å¥³' && s.major === 'æ–‡' && s.isGraduate),
                'å¥³æ€§æ–‡ç³»å­¦éƒ¨': students.filter(s => !s.assigned && s.gender === 'å¥³' && s.major === 'æ–‡' && !s.isGraduate),
                'ç”·æ€§ç†ç³»é™¢ç”Ÿ': students.filter(s => !s.assigned && s.gender === 'ç”·' && s.major === 'ç†' && s.isGraduate),
                'ç”·æ€§ç†ç³»å­¦éƒ¨': students.filter(s => !s.assigned && s.gender === 'ç”·' && s.major === 'ç†' && !s.isGraduate),
                'ç”·æ€§æ–‡ç³»é™¢ç”Ÿ': students.filter(s => !s.assigned && s.gender === 'ç”·' && s.major === 'æ–‡' && s.isGraduate),
                'ç”·æ€§æ–‡ç³»å­¦éƒ¨': students.filter(s => !s.assigned && s.gender === 'ç”·' && s.major === 'æ–‡' && !s.isGraduate)
            };
        }
        
        // æ—©ç¨²ç”°å¤§å­¦ã¨æ…¶æ‡‰å¤§å­¦ã®å„ªå…ˆé…åˆ†
        function allocatePriorityUniversities(tracker, groupTargetSizes) {
            // æ—©ç¨²ç”°ã¨æ…¶æ‡‰ã®å­¦ç”Ÿã‚’æŠ½å‡º
            const wasedaStudents = students.filter(s => !s.assigned && 
                (s.university.includes('æ—©ç¨²ç”°') || s.university.includes('Waseda')));
            const keioStudents = students.filter(s => !s.assigned && 
                (s.university.includes('æ…¶æ‡‰') || s.university.includes('æ…¶å¿œ') || s.university.includes('Keio')));
            
            // æ—©ç¨²ç”°å¤§å­¦ã®å­¦ç”Ÿã‚’å‡ç­‰é…åˆ†
            if (wasedaStudents.length > 0) {
                addDebugLog('PRIORITY', `æ—©ç¨²ç”°å¤§å­¦: ${wasedaStudents.length}åã‚’å‡ç­‰é…åˆ†`);
                distributeStudentsEvenly(wasedaStudents, tracker, groupTargetSizes, 'æ—©ç¨²ç”°å¤§å­¦');
            }
            
            // æ…¶æ‡‰å¤§å­¦ã®å­¦ç”Ÿã‚’å‡ç­‰é…åˆ†
            if (keioStudents.length > 0) {
                addDebugLog('PRIORITY', `æ…¶æ‡‰å¤§å­¦: ${keioStudents.length}åã‚’å‡ç­‰é…åˆ†`);
                distributeStudentsEvenly(keioStudents, tracker, groupTargetSizes, 'æ…¶æ‡‰å¤§å­¦');
            }
        }
        
        // ç‰¹å®šã®å­¦ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‡ç­‰ã«é…åˆ†
        function distributeStudentsEvenly(studentGroup, tracker, groupTargetSizes, universityName) {
            // å„ã‚°ãƒ«ãƒ¼ãƒ—ã«é…åˆ†ã™ã‚‹äººæ•°ã‚’è¨ˆç®—
            const baseCount = Math.floor(studentGroup.length / CONFIG.groupCount);
            const remainder = studentGroup.length % CONFIG.groupCount;
            
            let studentIndex = 0;
            
            // å„ã‚°ãƒ«ãƒ¼ãƒ—ã«åŸºæœ¬äººæ•°ã‚’é…åˆ†
            for (let g = 0; g < CONFIG.groupCount; g++) {
                const targetCount = baseCount + (g < remainder ? 1 : 0);
                let placedCount = 0;
                
                while (placedCount < targetCount && studentIndex < studentGroup.length) {
                    const student = studentGroup[studentIndex];
                    
                    if (groups[g].students.length < groupTargetSizes[g]) {
                        // åŒä¸€å­¦éƒ¨ã®ãƒã‚§ãƒƒã‚¯ã¯ã™ã‚‹ãŒã€å¤§å­¦é‡è¤‡åˆ¶ç´„ã¯ç·©å’Œ
                        const sameDept = student.department && 
                            groups[g].students.some(s => s.university === student.university && 
                                                       s.department === student.department);
                        const sameName = groups[g].students.some(s => s.name === student.name);
                        
                        if (!sameDept && !sameName) {
                            groups[g].students.push(student);
                            student.assigned = true;
                            student.groupId = g;
                            updateTracker(student, g, tracker);
                            placedCount++;
                            addDebugLog('PLACED', `${student.name} (${universityName}) ã‚’ã‚°ãƒ«ãƒ¼ãƒ—${g+1}ã«é…ç½®`);
                        }
                    }
                    
                    studentIndex++;
                }
            }
            
            // é…ç½®ã§ããªã‹ã£ãŸå­¦ç”ŸãŒã„ã‚‹å ´åˆã®å‡¦ç†
            const unplacedStudents = studentGroup.filter(s => !s.assigned);
            if (unplacedStudents.length > 0) {
                addDebugLog('WARNING', `${universityName}: ${unplacedStudents.length}åãŒæœªé…ç½®`);
                // å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§é…ç½®ã•ã‚Œã‚‹
            }
        }
        
        // å±æ€§åˆ¥å‡ç­‰é…åˆ†
        function allocateByAttributesEvenly(attributeTargets, tracker, groupTargetSizes) {
            const categories = categorizeStudents();
            
            for (const [categoryName, categoryStudents] of Object.entries(categories)) {
                if (categoryStudents.length === 0) continue;
                
                let groupIndex = 0;
                for (const student of categoryStudents) {
                    let placed = false;
                    let attempts = 0;
                    
                    while (!placed && attempts < CONFIG.groupCount) {
                        const currentGroup = (groupIndex + attempts) % CONFIG.groupCount;
                        
                        if (groups[currentGroup].students.length < groupTargetSizes[currentGroup]) {
                            if (canPlaceStudent(student, groups[currentGroup].students)) {
                                groups[currentGroup].students.push(student);
                                student.assigned = true;
                                student.groupId = currentGroup;
                                updateTracker(student, currentGroup, tracker);
                                placed = true;
                            }
                        }
                        
                        attempts++;
                    }
                    
                    groupIndex = (groupIndex + 1) % CONFIG.groupCount;
                }
            }
        }
        
        // é…ç½®å¯èƒ½ãƒã‚§ãƒƒã‚¯
        function canPlaceStudent(student, groupStudents) {
            // åŒä¸€å¤§å­¦ãƒã‚§ãƒƒã‚¯
            const sameUniv = groupStudents.filter(s => s.university === student.university);
            if (sameUniv.length >= CONFIG.maxUniversityPerGroup) {
                return false;
            }
            
            // åŒä¸€å¤§å­¦ãƒ»åŒä¸€å­¦éƒ¨ãƒã‚§ãƒƒã‚¯
            if (student.department && sameUniv.length > 0) {
                const sameDept = sameUniv.some(s => s.department === student.department);
                if (sameDept) {
                    return false;
                }
            }
            
            // åŒå§“åŒåãƒã‚§ãƒƒã‚¯
            const sameName = groupStudents.some(s => s.name === student.name);
            if (sameName) {
                return false;
            }
            
            return true;
        }
        
        // å¤§å­¦åˆ¶ç´„å‡¦ç†ï¼ˆæ”¹å–„ç‰ˆï¼‰
        function handleUniversityConstraintsImproved(universityInfo, tracker, groupTargetSizes) {
            for (const [university, univStudents] of Object.entries(universityInfo.studentsByUniversity)) {
                const assignedByGroup = {};
                const unassigned = [];
                
                for (let g = 0; g < CONFIG.groupCount; g++) {
                    assignedByGroup[g] = groups[g].students.filter(s => s.university === university).length;
                }
                
                for (const student of univStudents) {
                    if (!student.assigned) {
                        unassigned.push(student);
                    }
                }
                
                if (unassigned.length === 0) continue;
                
                for (const student of unassigned) {
                    let bestGroup = -1;
                    let minCount = Infinity;
                    let validGroups = [];
                    
                    for (let g = 0; g < CONFIG.groupCount; g++) {
                        if (groups[g].students.length >= groupTargetSizes[g]) continue;
                        if (assignedByGroup[g] >= CONFIG.maxUniversityPerGroup) continue;
                        
                        if (canPlaceStudent(student, groups[g].students)) {
                            validGroups.push({
                                index: g,
                                count: assignedByGroup[g]
                            });
                        }
                    }
                    
                    if (validGroups.length > 0) {
                        validGroups.sort((a, b) => a.count - b.count);
                        bestGroup = validGroups[0].index;
                    }
                    
                    if (bestGroup !== -1) {
                        groups[bestGroup].students.push(student);
                        student.assigned = true;
                        student.groupId = bestGroup;
                        assignedByGroup[bestGroup]++;
                        updateTracker(student, bestGroup, tracker);
                    }
                }
            }
        }
        
        // æ®‹ã‚Šå­¦ç”Ÿé…ç½®
        function allocateRemainingEvenly(tracker, groupTargetSizes) {
            const unassigned = students.filter(s => !s.assigned);
            
            if (unassigned.length === 0) return;
            
            const groupSizes = [];
            for (let i = 0; i < CONFIG.groupCount; i++) {
                groupSizes.push({
                    index: i,
                    current: groups[i].students.length,
                    target: groupTargetSizes[i],
                    available: groupTargetSizes[i] - groups[i].students.length
                });
            }
            
            groupSizes.sort((a, b) => b.available - a.available);
            
            for (const student of unassigned) {
                let placed = false;
                
                for (const group of groupSizes) {
                    if (group.available <= 0) continue;
                    
                    if (canPlaceStudent(student, groups[group.index].students)) {
                        groups[group.index].students.push(student);
                        student.assigned = true;
                        student.groupId = group.index;
                        group.current++;
                        group.available--;
                        updateTracker(student, group.index, tracker);
                        placed = true;
                        break;
                    }
                }
                
                if (!placed) {
                    for (const group of groupSizes) {
                        if (group.available <= 0) continue;
                        
                        groups[group.index].students.push(student);
                        student.assigned = true;
                        student.groupId = group.index;
                        group.current++;
                        group.available--;
                        updateTracker(student, group.index, tracker);
                        addDebugLog('WARNING', `${student.name}ã‚’åˆ¶ç´„ã‚’ç·©ã‚ã¦é…ç½®`);
                        break;
                    }
                }
            }
        }
        
        // æœ€çµ‚èª¿æ•´
        function finalAdjustment(tracker, attributeTargets, groupTargetSizes) {
            // åŒå§“åŒåãƒã‚§ãƒƒã‚¯
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const nameCount = {};
                const duplicates = [];
                
                groups[i].students.forEach(student => {
                    if (nameCount[student.name]) {
                        duplicates.push(student);
                    } else {
                        nameCount[student.name] = true;
                    }
                });
                
                for (const duplicate of duplicates) {
                    for (let j = 0; j < CONFIG.groupCount; j++) {
                        if (i === j) continue;
                        
                        const hasSameName = groups[j].students.some(s => s.name === duplicate.name);
                        if (!hasSameName && groups[j].students.length < groupTargetSizes[j]) {
                            groups[i].students = groups[i].students.filter(s => s !== duplicate);
                            groups[j].students.push(duplicate);
                            duplicate.groupId = j;
                            
                            addDebugLog('FINAL', `åŒå§“åŒå ${duplicate.name} ã‚’ã‚°ãƒ«ãƒ¼ãƒ—${i+1}ã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—${j+1}ã¸ç§»å‹•`);
                            break;
                        }
                    }
                }
            }
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
        function checkAndFixStep(step, description, attributeTargets, tracker, groupTargetSizes) {
            addDebugLog(step, `${description}ã®ãƒã‚§ãƒƒã‚¯é–‹å§‹`);
            
            const imbalances = checkAllImbalances(attributeTargets, tracker, groupTargetSizes);
            
            if (imbalances.hasAnyImbalance) {
                addDebugLog(step, `${description}: åã‚Šã‚’æ¤œå‡º`, imbalances);
                fixImbalances(imbalances, attributeTargets, tracker, groupTargetSizes);
                addDebugLog(step, `${description}: åã‚Šä¿®æ­£å®Œäº†`);
            } else {
                addDebugLog(step, `${description}: åã‚Šãªã— âœ“`);
            }
        }
        
        // åã‚Šãƒã‚§ãƒƒã‚¯
        function checkAllImbalances(attributeTargets, tracker, groupTargetSizes) {
            const result = {
                hasAnyImbalance: false,
                groupSizes: checkGroupSizeImbalance(groupTargetSizes),
                attributes: checkAttributeImbalances(attributeTargets, tracker),
                universities: checkUniversityImbalance()
            };
            
            result.hasAnyImbalance = result.groupSizes.hasImbalance || 
                                    result.attributes.hasImbalance || 
                                    result.universities.hasImbalance;
            
            return result;
        }
        
        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚ºåã‚Šãƒã‚§ãƒƒã‚¯
        function checkGroupSizeImbalance(groupTargetSizes) {
            const result = {
                hasImbalance: false,
                details: []
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const current = groups[i].students.length;
                const target = groupTargetSizes[i];
                const diff = current - target;
                
                if (Math.abs(diff) > 1) {
                    result.hasImbalance = true;
                    result.details.push({
                        groupId: i,
                        current: current,
                        target: target,
                        diff: diff
                    });
                }
            }
            
            return result;
        }
        
        // å±æ€§åã‚Šãƒã‚§ãƒƒã‚¯
        function checkAttributeImbalances(attributeTargets, tracker) {
            const result = {
                hasImbalance: false,
                female: [],
                science: [],
                graduate: []
            };
            
            const attributes = ['female', 'science', 'graduate'];
            
            for (const attr of attributes) {
                const distribution = attributeTargets[attr].distribution;
                
                for (let i = 0; i < CONFIG.groupCount; i++) {
                    const current = tracker.attributes[attr][i];
                    const target = distribution[i];
                    const diff = current - target;
                    
                    if (Math.abs(diff) > 1) {
                        result.hasImbalance = true;
                        result[attr].push({
                            groupId: i,
                            current: current,
                            target: target,
                            diff: diff
                        });
                    }
                }
            }
            
            return result;
        }
        
        // å¤§å­¦åã‚Šãƒã‚§ãƒƒã‚¯
        function checkUniversityImbalance() {
            const result = {
                hasImbalance: false,
                details: []
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const universities = {};
                groups[i].students.forEach(s => {
                    if (s.university) {
                        universities[s.university] = (universities[s.university] || 0) + 1;
                    }
                });
                
                for (const [univ, count] of Object.entries(universities)) {
                    if (count > CONFIG.maxUniversityPerGroup) {
                        result.hasImbalance = true;
                        result.details.push({
                            groupId: i,
                            university: univ,
                            count: count,
                            excess: count - CONFIG.maxUniversityPerGroup
                        });
                    }
                }
            }
            
            return result;
        }
        
        // åã‚Šä¿®æ­£ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function fixImbalances(imbalances, attributeTargets, tracker, groupTargetSizes) {
            // ã“ã“ã«è©³ç´°ãªä¿®æ­£ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
            // ä»Šå›ã¯ç°¡æ˜“ç‰ˆã¨ã—ã¦è­¦å‘Šã®ã¿
            if (imbalances.hasAnyImbalance) {
                addDebugLog('FIX', 'åã‚Šã‚’æ¤œå‡ºã—ã¾ã—ãŸãŒã€è‡ªå‹•ä¿®æ­£ã¯éƒ¨åˆ†çš„ã§ã™');
            }
        }
        
        // å¾¹åº•çš„ãªæœ€çµ‚ãƒã‚§ãƒƒã‚¯ã¨èª¿æ•´
        function performComprehensiveFinalCheck(attributeTargets, tracker, groupTargetSizes) {
            addDebugLog('CHECK', 'å¾¹åº•çš„ãªæœ€çµ‚ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹');
            
            let adjustmentsMade = true;
            let iterations = 0;
            const maxIterations = 10;
            
            while (adjustmentsMade && iterations < maxIterations) {
                adjustmentsMade = false;
                iterations++;
                addDebugLog('CHECK', `èª¿æ•´ãƒ©ã‚¦ãƒ³ãƒ‰ ${iterations} é–‹å§‹`);
                
                // 1. åŒå§“åŒåãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
                adjustmentsMade |= fixDuplicateNames();
                
                // 2. ã‚°ãƒ«ãƒ¼ãƒ—äººæ•°ã®å‡ç­‰æ€§ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
                adjustmentsMade |= balanceGroupSizes(groupTargetSizes);
                
                // 3. å±æ€§ã®å‡ç­‰æ€§ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£ï¼ˆå¥³æ€§ã€ç†ç³»ã€é™¢ç”Ÿï¼‰
                adjustmentsMade |= balanceAttributes(['female', 'science', 'graduate']);
                
                // 4. æ—©ç¨²ç”°ãƒ»æ…¶æ‡‰ã®å‡ç­‰æ€§ãƒã‚§ãƒƒã‚¯ã¨ä¿®æ­£
                adjustmentsMade |= balanceWasedaKeio();
                
                if (adjustmentsMade) {
                    addDebugLog('CHECK', `èª¿æ•´ãƒ©ã‚¦ãƒ³ãƒ‰ ${iterations} ã§ä¿®æ­£ã‚’å®Ÿæ–½`);
                }
            }
            
            if (iterations >= maxIterations) {
                addDebugLog('WARNING', 'æœ€å¤§èª¿æ•´å›æ•°ã«é”ã—ã¾ã—ãŸ');
            } else {
                addDebugLog('CHECK', `${iterations}å›ã®èª¿æ•´ã§å®Œå…¨ã«å‡ç­‰åŒ–ã•ã‚Œã¾ã—ãŸ`);
            }
        }
        
        // åŒå§“åŒåã®ä¿®æ­£
        function fixDuplicateNames() {
            let fixed = false;
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const nameCount = {};
                const duplicates = [];
                
                groups[i].students.forEach(student => {
                    if (nameCount[student.name]) {
                        duplicates.push(student);
                    } else {
                        nameCount[student.name] = 1;
                    }
                });
                
                for (const duplicate of duplicates) {
                    // ä»–ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¢ã—ã¦ç§»å‹•
                    for (let j = 0; j < CONFIG.groupCount; j++) {
                        if (i === j) continue;
                        
                        const hasSameName = groups[j].students.some(s => s.name === duplicate.name);
                        if (!hasSameName) {
                            // äº¤æ›å¯èƒ½ãªå­¦ç”Ÿã‚’æ¢ã™
                            for (const candidate of groups[j].students) {
                                if (!groups[i].students.some(s => s.name === candidate.name)) {
                                    // äº¤æ›å®Ÿè¡Œ
                                    groups[i].students = groups[i].students.filter(s => s !== duplicate);
                                    groups[j].students = groups[j].students.filter(s => s !== candidate);
                                    groups[i].students.push(candidate);
                                    groups[j].students.push(duplicate);
                                    duplicate.groupId = j;
                                    candidate.groupId = i;
                                    
                                    addDebugLog('FIX', `åŒå§“åŒåä¿®æ­£: ${duplicate.name}ã‚’ã‚°ãƒ«ãƒ¼ãƒ—${i+1}ã‹ã‚‰${j+1}ã¸`);
                                    fixed = true;
                                    break;
                                }
                            }
                            if (fixed) break;
                        }
                    }
                    if (fixed) break;
                }
            }
            
            return fixed;
        }
        
        // ã‚°ãƒ«ãƒ¼ãƒ—äººæ•°ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
        function balanceGroupSizes(groupTargetSizes) {
            let adjusted = false;
            const sizes = [];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                sizes.push({
                    index: i,
                    current: groups[i].students.length,
                    target: groupTargetSizes[i],
                    diff: groups[i].students.length - groupTargetSizes[i]
                });
            }
            
            // æœ€ã‚‚äººæ•°ãŒå¤šã„ã‚°ãƒ«ãƒ¼ãƒ—ã¨å°‘ãªã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç‰¹å®š
            sizes.sort((a, b) => b.diff - a.diff);
            
            // 2åä»¥ä¸Šã®å·®ãŒã‚ã‚‹å ´åˆã¯èª¿æ•´
            if (sizes[0].diff > 0 && sizes[sizes.length - 1].diff < 0 && 
                (sizes[0].current - sizes[sizes.length - 1].current) > 1) {
                
                const fromGroup = sizes[0].index;
                const toGroup = sizes[sizes.length - 1].index;
                
                // ç§»å‹•å¯èƒ½ãªå­¦ç”Ÿã‚’æ¢ã™
                for (const student of groups[fromGroup].students) {
                    if (canPlaceStudent(student, groups[toGroup].students)) {
                        // ç§»å‹•å®Ÿè¡Œ
                        groups[fromGroup].students = groups[fromGroup].students.filter(s => s !== student);
                        groups[toGroup].students.push(student);
                        student.groupId = toGroup;
                        
                        addDebugLog('BALANCE', `äººæ•°èª¿æ•´: ${student.name}ã‚’ã‚°ãƒ«ãƒ¼ãƒ—${fromGroup+1}ï¼ˆ${sizes[0].current}åï¼‰ã‹ã‚‰${toGroup+1}ï¼ˆ${sizes[sizes.length-1].current}åï¼‰ã¸`);
                        adjusted = true;
                        break;
                    }
                }
            }
            
            return adjusted;
        }
        
        // å±æ€§ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
        function balanceAttributes(attributes) {
            let adjusted = false;
            
            for (const attr of attributes) {
                const distribution = calculateCurrentAttributeDistribution(attr);
                const targetDist = calculateTargetDistribution(distribution.total);
                
                // æœ€ã‚‚åã£ã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç‰¹å®š
                let maxDiff = 0;
                let fromGroup = -1;
                let toGroup = -1;
                
                for (let i = 0; i < CONFIG.groupCount; i++) {
                    const current = distribution.byGroup[i];
                    const target = targetDist[i];
                    const diff = current - target;
                    
                    if (Math.abs(diff) > 1) {
                        for (let j = 0; j < CONFIG.groupCount; j++) {
                            if (i === j) continue;
                            const otherDiff = distribution.byGroup[j] - targetDist[j];
                            if (diff > 0 && otherDiff < 0 && Math.abs(diff - otherDiff) > maxDiff) {
                                maxDiff = Math.abs(diff - otherDiff);
                                fromGroup = i;
                                toGroup = j;
                            }
                        }
                    }
                }
                
                // èª¿æ•´ãŒå¿…è¦ãªå ´åˆ
                if (fromGroup !== -1 && toGroup !== -1) {
                    const moved = moveStudentByAttribute(attr, fromGroup, toGroup);
                    if (moved) {
                        adjusted = true;
                        addDebugLog('BALANCE', `${getAttributeName(attr)}ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ã‚’å®Ÿæ–½`);
                    }
                }
            }
            
            return adjusted;
        }
        
        // æ—©ç¨²ç”°ãƒ»æ…¶æ‡‰ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
        function balanceWasedaKeio() {
            let adjusted = false;
            const universities = ['æ—©ç¨²ç”°', 'æ…¶æ‡‰'];
            
            for (const univ of universities) {
                const distribution = calculateUniversityDistribution(univ);
                if (distribution.total === 0) continue;
                
                const targetDist = calculateTargetDistribution(distribution.total);
                
                // æœ€ã‚‚åã£ã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç‰¹å®š
                let maxDiff = 0;
                let fromGroup = -1;
                let toGroup = -1;
                
                for (let i = 0; i < CONFIG.groupCount; i++) {
                    const current = distribution.byGroup[i];
                    const target = targetDist[i];
                    const diff = current - target;
                    
                    if (Math.abs(diff) > 1) {
                        for (let j = 0; j < CONFIG.groupCount; j++) {
                            if (i === j) continue;
                            const otherDiff = distribution.byGroup[j] - targetDist[j];
                            if (diff > 0 && otherDiff < 0) {
                                maxDiff = Math.abs(diff - otherDiff);
                                fromGroup = i;
                                toGroup = j;
                            }
                        }
                    }
                }
                
                // èª¿æ•´å®Ÿè¡Œ
                if (fromGroup !== -1 && toGroup !== -1) {
                    const moved = moveStudentByUniversity(univ, fromGroup, toGroup);
                    if (moved) {
                        adjusted = true;
                        addDebugLog('BALANCE', `${univ}å¤§å­¦ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ã‚’å®Ÿæ–½`);
                    }
                }
            }
            
            return adjusted;
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function calculateCurrentAttributeDistribution(attr) {
            const result = { total: 0, byGroup: [] };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                let count = 0;
                if (attr === 'female') {
                    count = groups[i].students.filter(s => s.gender === 'å¥³').length;
                } else if (attr === 'science') {
                    count = groups[i].students.filter(s => s.major === 'ç†').length;
                } else if (attr === 'graduate') {
                    count = groups[i].students.filter(s => s.isGraduate).length;
                }
                result.byGroup.push(count);
                result.total += count;
            }
            
            return result;
        }
        
        function calculateUniversityDistribution(univKeyword) {
            const result = { total: 0, byGroup: [] };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const count = groups[i].students.filter(s => 
                    s.university.includes(univKeyword) || 
                    (univKeyword === 'æ…¶æ‡‰' && (s.university.includes('æ…¶å¿œ') || s.university.includes('Keio'))) ||
                    (univKeyword === 'æ—©ç¨²ç”°' && s.university.includes('Waseda'))
                ).length;
                result.byGroup.push(count);
                result.total += count;
            }
            
            return result;
        }
        
        function calculateTargetDistribution(total) {
            const base = Math.floor(total / CONFIG.groupCount);
            const remainder = total % CONFIG.groupCount;
            const distribution = [];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                distribution.push(base + (i < remainder ? 1 : 0));
            }
            
            return distribution;
        }
        
        function moveStudentByAttribute(attr, fromGroup, toGroup) {
            // æ¡ä»¶ã«åˆã†å­¦ç”Ÿã‚’æ¢ã™
            for (const student of groups[fromGroup].students) {
                let matches = false;
                if (attr === 'female' && student.gender === 'å¥³') matches = true;
                else if (attr === 'science' && student.major === 'ç†') matches = true;
                else if (attr === 'graduate' && student.isGraduate) matches = true;
                
                if (matches && canPlaceStudent(student, groups[toGroup].students)) {
                    // ç§»å‹•å®Ÿè¡Œ
                    groups[fromGroup].students = groups[fromGroup].students.filter(s => s !== student);
                    groups[toGroup].students.push(student);
                    student.groupId = toGroup;
                    return true;
                }
            }
            
            return false;
        }
        
        function moveStudentByUniversity(univKeyword, fromGroup, toGroup) {
            for (const student of groups[fromGroup].students) {
                if ((student.university.includes(univKeyword) || 
                    (univKeyword === 'æ…¶æ‡‰' && (student.university.includes('æ…¶å¿œ') || student.university.includes('Keio'))) ||
                    (univKeyword === 'æ—©ç¨²ç”°' && student.university.includes('Waseda'))) &&
                    canPlaceStudent(student, groups[toGroup].students)) {
                    
                    // ç§»å‹•å®Ÿè¡Œ
                    groups[fromGroup].students = groups[fromGroup].students.filter(s => s !== student);
                    groups[toGroup].students.push(student);
                    student.groupId = toGroup;
                    return true;
                }
            }
            
            return false;
        }
        
        function getAttributeName(attr) {
            if (attr === 'female') return 'å¥³æ€§';
            if (attr === 'science') return 'ç†ç³»';
            if (attr === 'graduate') return 'é™¢ç”Ÿ';
            return attr;
        }
        
        // æœ€çµ‚ç¢ºèª
        function performFinalCheck(attributeTargets, tracker, groupTargetSizes) {
            const finalCheck = {
                totalAssigned: 0,
                groupSizes: [],
                attributeDistribution: {
                    female: [],
                    science: [],
                    graduate: []
                }
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                finalCheck.totalAssigned += groups[i].students.length;
                finalCheck.groupSizes.push(groups[i].students.length);
            }
            
            addDebugLog('FINAL', 'é…åˆ†å®Œäº†', finalCheck);
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function initializeTracker() {
            return {
                groupCount: CONFIG.groupCount,
                assigned: Array(CONFIG.groupCount).fill(0),
                attributes: {
                    female: Array(CONFIG.groupCount).fill(0),
                    science: Array(CONFIG.groupCount).fill(0),
                    graduate: Array(CONFIG.groupCount).fill(0)
                }
            };
        }
        
        function calculateAttributeTargets() {
            const femaleStudents = students.filter(s => s.gender === 'å¥³');
            const scienceStudents = students.filter(s => s.major === 'ç†');
            const graduateStudents = students.filter(s => s.isGraduate);
            
            return {
                female: {
                    total: femaleStudents.length,
                    distribution: calculateDistribution(femaleStudents.length)
                },
                science: {
                    total: scienceStudents.length,
                    distribution: calculateDistribution(scienceStudents.length)
                },
                graduate: {
                    total: graduateStudents.length,
                    distribution: calculateDistribution(graduateStudents.length)
                }
            };
        }
        
        function calculateDistribution(total) {
            const base = Math.floor(total / CONFIG.groupCount);
            const remainder = total % CONFIG.groupCount;
            const distribution = [];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                distribution.push(base + (i < remainder ? 1 : 0));
            }
            
            return distribution;
        }
        
        function calculateGroupSizes(totalStudents, groupCount) {
            const baseSize = Math.floor(totalStudents / groupCount);
            const remainder = totalStudents % groupCount;
            
            const sizes = [];
            for (let i = 0; i < groupCount; i++) {
                sizes.push(baseSize + (i < remainder ? 1 : 0));
            }
            
            return sizes;
        }
        
        function analyzeUniversities() {
            const universityCount = {};
            const studentsByUniversity = {};
            
            students.forEach(student => {
                const univ = student.university;
                if (!universityCount[univ]) {
                    universityCount[univ] = 0;
                    studentsByUniversity[univ] = [];
                }
                universityCount[univ]++;
                studentsByUniversity[univ].push(student);
            });
            
            return {
                universityCount,
                studentsByUniversity
            };
        }
        
        function updateTracker(student, groupId, tracker) {
            tracker.assigned[groupId]++;
            
            if (student.gender === 'å¥³') {
                tracker.attributes.female[groupId]++;
            }
            if (student.major === 'ç†') {
                tracker.attributes.science[groupId]++;
            }
            if (student.isGraduate) {
                tracker.attributes.graduate[groupId]++;
            }
        }
        
        // çµæœè¡¨ç¤º
        function displayResults() {
            // æ—©æ…¶ã®åˆ†å¸ƒã‚’è¨ˆç®—
            const wasedaKeioDistribution = calculateWasedaKeioDistribution();
            
            // æ—©æ…¶åˆ†å¸ƒã®è¡¨ç¤º
            let distributionHtml = '';
            if (wasedaKeioDistribution.waseda.total > 0 || wasedaKeioDistribution.keio.total > 0) {
                distributionHtml = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeaa7;">';
                distributionHtml += '<h3 style="margin: 0 0 10px 0; color: #856404;">ğŸ« æ—©ç¨²ç”°å¤§å­¦ãƒ»æ…¶æ‡‰å¤§å­¦ã®åˆ†å¸ƒçŠ¶æ³</h3>';
                
                if (wasedaKeioDistribution.waseda.total > 0) {
                    distributionHtml += `<p style="margin: 5px 0;">æ—©ç¨²ç”°å¤§å­¦: åˆè¨ˆ${wasedaKeioDistribution.waseda.total}å`;
                    distributionHtml += ` (å„ã‚°ãƒ«ãƒ¼ãƒ—: ${wasedaKeioDistribution.waseda.distribution.join(', ')})</p>`;
                }
                
                if (wasedaKeioDistribution.keio.total > 0) {
                    distributionHtml += `<p style="margin: 5px 0;">æ…¶æ‡‰å¤§å­¦: åˆè¨ˆ${wasedaKeioDistribution.keio.total}å`;
                    distributionHtml += ` (å„ã‚°ãƒ«ãƒ¼ãƒ—: ${wasedaKeioDistribution.keio.distribution.join(', ')})</p>`;
                }
                
                distributionHtml += '</div>';
            }
            
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            let summaryHtml = distributionHtml + '<div class="stats-grid">';
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                
                summaryHtml += `
                    <div class="stat-card">
                        <div style="font-weight: bold; color: #007bff; margin-bottom: 10px;">ã‚°ãƒ«ãƒ¼ãƒ—${i + 1}</div>
                        <div>äººæ•°: ${group.students.length}å</div>
                        <div style="font-size: 0.9em; color: #6c757d;">
                            å¥³æ€§${stats.female} / ç†ç³»${stats.science} / é™¢ç”Ÿ${stats.graduate}
                        </div>
                    </div>
                `;
            }
            summaryHtml += '</div>';
            document.getElementById('results-summary').innerHTML = summaryHtml;
        }
        
        // æ—©ç¨²ç”°ãƒ»æ…¶æ‡‰ã®åˆ†å¸ƒã‚’è¨ˆç®—
        function calculateWasedaKeioDistribution() {
            const result = {
                waseda: { total: 0, distribution: [] },
                keio: { total: 0, distribution: [] }
            };
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const wasedaCount = groups[i].students.filter(s => 
                    s.university.includes('æ—©ç¨²ç”°') || s.university.includes('Waseda')
                ).length;
                const keioCount = groups[i].students.filter(s => 
                    s.university.includes('æ…¶æ‡‰') || s.university.includes('æ…¶å¿œ') || s.university.includes('Keio')
                ).length;
                
                result.waseda.distribution.push(wasedaCount);
                result.waseda.total += wasedaCount;
                result.keio.distribution.push(keioCount);
                result.keio.total += keioCount;
            }
            
            return result;
        }
        
        // ã‚°ãƒ«ãƒ¼ãƒ—çµ±è¨ˆè¨ˆç®—
        function calculateGroupStats(students) {
            return {
                female: students.filter(s => s.gender === 'å¥³').length,
                science: students.filter(s => s.major === 'ç†').length,
                graduate: students.filter(s => s.isGraduate).length
            };
        }
        
        // è©³ç´°çµæœè¡¨ç¤º
        function showDetailedResults() {
            let html = '<div class="group-grid">';
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                html += `
                    <div class="group-card">
                        <div class="group-header">ã‚°ãƒ«ãƒ¼ãƒ—${i + 1} (${group.students.length}å)</div>
                        <div>
                `;
                
                group.students.forEach(s => {
                    html += `
                        <div class="student-item">
                            ${s.name} - ${s.university}
                            ${s.department ? `(${s.department})` : ''}
                            ${s.isGraduate ? 'ã€é™¢ã€‘' : ''}
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            html += '</div>';
            document.getElementById('groups-display').innerHTML = html;
        }
        
        // Excelå‡ºåŠ›
        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // ã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆ
            const summaryData = [
                ['ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†çµæœã‚µãƒãƒªãƒ¼'],
                ['ç”Ÿæˆæ—¥æ™‚', new Date().toLocaleString()],
                [''],
                ['ã‚°ãƒ«ãƒ¼ãƒ—', 'äººæ•°', 'å¥³æ€§', 'ç†ç³»', 'é™¢ç”Ÿ']
            ];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                summaryData.push([
                    `ã‚°ãƒ«ãƒ¼ãƒ—${i + 1}`,
                    group.students.length,
                    stats.female,
                    stats.science,
                    stats.graduate
                ]);
            }
            
            const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWS, 'ã‚µãƒãƒªãƒ¼');
            
            // è©³ç´°ã‚·ãƒ¼ãƒˆ
            const detailData = [['ã‚°ãƒ«ãƒ¼ãƒ—']];
            
            // å…ƒãƒ‡ãƒ¼ã‚¿ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
            headers.forEach(header => {
                detailData[0].push(header);
            });
            
            // å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                group.students.forEach(student => {
                    const row = [`ã‚°ãƒ«ãƒ¼ãƒ—${i + 1}`];
                    student.originalData.forEach(cell => {
                        row.push(cell);
                    });
                    detailData.push(row);
                });
            }
            
            const detailWS = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, detailWS, 'è©³ç´°');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
            const date = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†çµæœ_${date}.xlsx`);
        }
        
        // HTMLå‡ºåŠ›é–¢æ•°ã‚’ä¿®æ­£
        function downloadHTML() {
            // HTMLç”Ÿæˆæ™‚ã«JSONãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            const groupsJSON = JSON.stringify(groups);
            // CONFIGã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢å¼ã«å¤‰æ›
            const configData = {
                groupCount: CONFIG.groupCount,
                maxUniversityPerGroup: CONFIG.maxUniversityPerGroup
            };
            const configJSON = JSON.stringify(configData);
            // å…ƒãƒ‡ãƒ¼ã‚¿ã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚‚æ¸¡ã™
            const headersJSON = JSON.stringify(headers);
            
            // Blob APIã‚’ä½¿ç”¨ã—ã¦HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            const blob = new Blob([generateEditableHTML(groupsJSON, configJSON, headersJSON)], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†çµæœ_${new Date().toISOString().slice(0, 10)}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ç·¨é›†å¯èƒ½ãªHTMLã‚’ç”Ÿæˆï¼ˆä¿®æ­£ç‰ˆï¼‰
        function generateEditableHTML(groupsJSON, configJSON, headersJSON) {
            // HTMLãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ§‹ç¯‰
            const html = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†çµæœ - ç·¨é›†å¯èƒ½ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>
    <style>
        /* ã“ã“ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨˜è¿° */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .control-panel { position: fixed; top: 20px; right: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-width: 250px; }
        .control-button { display: block; width: 100%; padding: 10px; margin: 5px 0; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
        .control-button:hover { background: #2980b9; }
        .control-button.excel { background: #27ae60; }
        .control-button.excel:hover { background: #229954; }
        .control-button.undo { background: #e74c3c; }
        .control-button.undo:hover { background: #c0392b; }
        .summary { margin-bottom: 40px; }
        .summary table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden; }
        .summary th, .summary td { padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; }
        .summary th { background: #f8f9fa; font-weight: bold; color: #495057; }
        .groups-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .group-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: all 0.3s; }
        .group-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
        .group-title { font-size: 1.2em; font-weight: bold; color: #007bff; margin-bottom: 10px; }
        .group-stats { font-size: 0.9em; color: #6c757d; margin-bottom: 15px; }
        .student-list { min-height: 100px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 2px dashed transparent; transition: all 0.3s; }
        .student-list.drag-over { background: #e3f2fd; border-color: #2196f3; }
        .student-item { padding: 10px; margin: 5px 0; background: white; border-radius: 6px; cursor: move; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .student-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .student-item.dragging { opacity: 0.5; }
        .student-name { font-weight: bold; color: #333; }
        .student-info { font-size: 0.85em; color: #666; margin-top: 4px; }
        @media (max-width: 768px) {
            .control-panel { position: static; margin-bottom: 20px; max-width: 100%; }
            .groups-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†çµæœ - æ‰‹å‹•èª¿æ•´å¯èƒ½ç‰ˆ</h1>
        
        <div class="control-panel">
            <h3 style="margin: 0 0 15px 0; font-size: 16px;">æ‰‹å‹•èª¿æ•´ãƒ„ãƒ¼ãƒ«</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                å­¦ç”Ÿã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç§»å‹•ã§ãã¾ã™
            </p>
            <button class="control-button undo" onclick="undoLastMove()" id="undoBtn" disabled>
                å…ƒã«æˆ»ã™
            </button>
            <button class="control-button excel" onclick="downloadExcel()">
                Excelã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </button>
            <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
            <div id="moveHistory" style="font-size: 12px; color: #666; max-height: 200px; overflow-y: auto;">
                <strong>ç§»å‹•å±¥æ­´:</strong>
                <div id="historyList"><em>ã¾ã ç§»å‹•ã—ã¦ã„ã¾ã›ã‚“</em></div>
            </div>
        </div>
        
        <div id="summary-container"></div>
        <div id="groups-container"></div>
    </div>
    
    <script>
        // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
        let groups = ${groupsJSON};
        const CONFIG = ${configJSON};
        const headers = ${headersJSON};
        let moveHistory = [];
        let draggedStudent = null;
        let sourceGroup = null;
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', function() {
            renderGroups();
            renderSummary();
        });
        
        // ã‚°ãƒ«ãƒ¼ãƒ—è¡¨ç¤º
        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.className = 'groups-container';
            container.innerHTML = '';
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card';
                groupCard.innerHTML = \`
                    <div class="group-title">ã‚°ãƒ«ãƒ¼ãƒ—\${i + 1} (\${group.students.length}å)</div>
                    <div class="group-stats">
                        å¥³æ€§\${stats.female}å / ç†ç³»\${stats.science}å / é™¢ç”Ÿ\${stats.graduate}å
                    </div>
                    <div class="student-list" data-group="\${i}">
                        \${group.students.map(s => \`
                            <div class="student-item" draggable="true" 
                                 data-student='\${JSON.stringify(s).replace(/'/g, "&#39;")}'
                                 data-group="\${i}">
                                <div class="student-name">\${s.name}</div>
                                <div class="student-info">
                                    \${s.university}\${s.department ? \` (\${s.department})\` : ''}
                                    \${s.isGraduate ? ' ã€é™¢ã€‘' : ''}
                                    / \${s.gender} / \${s.major}
                                </div>
                            </div>
                        \`).join('')}
                    </div>
                \`;
                
                container.appendChild(groupCard);
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupDragAndDrop();
        }
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function renderSummary() {
            const container = document.getElementById('summary-container');
            container.className = 'summary';
            
            let html = '<h2>ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥å±æ€§ã‚µãƒãƒªãƒ¼</h2><table><thead><tr>';
            html += '<th>ã‚°ãƒ«ãƒ¼ãƒ—</th><th>äººæ•°</th><th>å¥³æ€§</th><th>ç”·æ€§</th>';
            html += '<th>ç†ç³»</th><th>æ–‡ç³»</th><th>é™¢ç”Ÿ</th><th>å­¦éƒ¨ç”Ÿ</th>';
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                html += \`<tr>
                    <td>ã‚°ãƒ«ãƒ¼ãƒ—\${i + 1}</td>
                    <td>\${group.students.length}</td>
                    <td>\${stats.female}</td>
                    <td>\${group.students.length - stats.female}</td>
                    <td>\${stats.science}</td>
                    <td>\${group.students.length - stats.science}</td>
                    <td>\${stats.graduate}</td>
                    <td>\${group.students.length - stats.graduate}</td>
                </tr>\`;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®è¨­å®š
        function setupDragAndDrop() {
            // å­¦ç”Ÿã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.student-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
            
            // å­¦ç”Ÿãƒªã‚¹ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.student-list').forEach(list => {
                list.addEventListener('dragover', allowDrop);
                list.addEventListener('drop', handleDrop);
                list.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        function handleDragStart(e) {
            draggedStudent = JSON.parse(e.target.dataset.student);
            sourceGroup = parseInt(e.target.dataset.group);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—è¨±å¯
        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        // ãƒ‰ãƒ©ãƒƒã‚°é›¢è„±
        function handleDragLeave(e) {
            if (e.target.classList.contains('student-list')) {
                e.target.classList.remove('drag-over');
            }
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleDrop(e) {
            e.preventDefault();
            const targetGroup = parseInt(e.currentTarget.dataset.group);
            e.currentTarget.classList.remove('drag-over');
            
            if (sourceGroup === targetGroup) return;
            
            // ç§»å‹•å±¥æ­´ã‚’ä¿å­˜
            moveHistory.push({
                student: draggedStudent,
                from: sourceGroup,
                to: targetGroup,
                timestamp: new Date()
            });
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            groups[sourceGroup].students = groups[sourceGroup].students.filter(
                s => s.name !== draggedStudent.name || s.university !== draggedStudent.university
            );
            
            groups[targetGroup].students.push(draggedStudent);
            
            // UIã‚’æ›´æ–°
            renderGroups();
            renderSummary();
            updateMoveHistory();
            
            // Undoãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('undoBtn').disabled = false;
        }
        
        // ç§»å‹•ã‚’å…ƒã«æˆ»ã™
        function undoLastMove() {
            if (moveHistory.length === 0) return;
            
            const lastMove = moveHistory.pop();
            
            // ç§»å‹•ã‚’å…ƒã«æˆ»ã™
            groups[lastMove.to].students = groups[lastMove.to].students.filter(
                s => s.name !== lastMove.student.name || s.university !== lastMove.student.university
            );
            
            groups[lastMove.from].students.push(lastMove.student);
            
            // UIã‚’æ›´æ–°
            renderGroups();
            renderSummary();
            updateMoveHistory();
            
            // å±¥æ­´ãŒç©ºã«ãªã£ãŸã‚‰Undoãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            if (moveHistory.length === 0) {
                document.getElementById('undoBtn').disabled = true;
            }
        }
        
        // ç§»å‹•å±¥æ­´ã‚’æ›´æ–°
        function updateMoveHistory() {
            const historyList = document.getElementById('historyList');
            
            if (moveHistory.length === 0) {
                historyList.innerHTML = '<em>ã¾ã ç§»å‹•ã—ã¦ã„ã¾ã›ã‚“</em>';
                return;
            }
            
            historyList.innerHTML = moveHistory.slice(-5).reverse().map(move => \`
                <div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                    \${move.student.name} (ã‚°ãƒ«ãƒ¼ãƒ—\${move.from + 1} â†’ \${move.to + 1})
                </div>
            \`).join('');
        }
        
        // ã‚°ãƒ«ãƒ¼ãƒ—çµ±è¨ˆè¨ˆç®—
        function calculateGroupStats(students) {
            return {
                female: students.filter(s => s.gender === 'å¥³').length,
                science: students.filter(s => s.major === 'ç†').length,
                graduate: students.filter(s => s.isGraduate).length
            };
        }
        
        // Excelå‡ºåŠ›
        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            
            // ã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆ
            const summaryData = [
                ['ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†çµæœã‚µãƒãƒªãƒ¼ (æ‰‹å‹•èª¿æ•´æ¸ˆã¿)'],
                ['ç”Ÿæˆæ—¥æ™‚', new Date().toLocaleString()],
                ['ç§»å‹•å›æ•°', moveHistory.length + 'å›'],
                [''],
                ['ã‚°ãƒ«ãƒ¼ãƒ—', 'äººæ•°', 'å¥³æ€§', 'ç†ç³»', 'é™¢ç”Ÿ']
            ];
            
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                const stats = calculateGroupStats(group.students);
                summaryData.push([
                    'ã‚°ãƒ«ãƒ¼ãƒ—' + (i + 1),
                    group.students.length,
                    stats.female,
                    stats.science,
                    stats.graduate
                ]);
            }
            
            const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWS, 'ã‚µãƒãƒªãƒ¼');
            
            // è©³ç´°ã‚·ãƒ¼ãƒˆï¼ˆå…ƒãƒ‡ãƒ¼ã‚¿ã®å…¨åˆ—ã‚’å«ã‚€ï¼‰
            const detailData = [['ã‚°ãƒ«ãƒ¼ãƒ—']];
            
            // å…ƒãƒ‡ãƒ¼ã‚¿ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
            if (headers && headers.length > 0) {
                headers.forEach(header => {
                    detailData[0].push(header);
                });
            } else {
                // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ãŒãªã„å ´åˆã¯åŸºæœ¬æƒ…å ±ã®ã¿
                detailData[0].push('æ°å', 'å¤§å­¦', 'å­¦éƒ¨', 'æ–‡ç†', 'æ€§åˆ¥', 'å­¦æ ¡åŒºåˆ†');
            }
            
            // å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            for (let i = 0; i < CONFIG.groupCount; i++) {
                const group = groups[i];
                group.students.forEach(student => {
                    const row = ['ã‚°ãƒ«ãƒ¼ãƒ—' + (i + 1)];
                    
                    // originalDataãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    if (student.originalData && student.originalData.length > 0) {
                        student.originalData.forEach(cell => {
                            row.push(cell);
                        });
                    } else {
                        // originalDataãŒãªã„å ´åˆã¯åŸºæœ¬æƒ…å ±ã®ã¿
                        row.push(
                            student.name,
                            student.university || '',
                            student.department || '',
                            student.major === 'ç†' ? 'ç†ç³»' : 'æ–‡ç³»',
                            student.gender === 'å¥³' ? 'å¥³æ€§' : 'ç”·æ€§',
                            student.isGraduate ? 'å¤§å­¦é™¢' : 'å¤§å­¦ç”Ÿ'
                        );
                    }
                    
                    detailData.push(row);
                });
            }
            
            const detailWS = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, detailWS, 'è©³ç´°');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const date = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, 'ã‚°ãƒ«ãƒ¼ãƒ—é…åˆ†çµæœ_èª¿æ•´æ¸ˆã¿_' + date + '.xlsx');
        }
    <\/script>
</body>
</html>`;
            
            return html;
        }
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        function addDebugLog(step, message, details = null) {
            debugLog.push({
                step,
                message,
                details,
                timestamp: new Date().toISOString()
            });
        }
        
        function showDebugLog() {
            const logDiv = document.getElementById('debug-log');
            logDiv.style.display = logDiv.style.display === 'none' ? 'block' : 'none';
            
            if (logDiv.style.display === 'block') {
                let html = '<h3>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h3>';
                debugLog.forEach(entry => {
                    html += `<div class="debug-entry">
                        <strong>[${entry.step}]</strong> ${entry.message}
                        ${entry.details ? `<br>è©³ç´°: ${JSON.stringify(entry.details)}` : ''}
                    </div>`;
                });
                logDiv.innerHTML = html;
            }
        }
        
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'flex';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>